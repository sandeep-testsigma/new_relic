import{j as c,az as S,p,J as E,aA as y,x as w,G as o,T as u,aa as A,B as l,aB as T,aC as M,aD as v,aE as d,aF as D,w as m,s as I,h as b,a as x,S as O,aG as k,d as f,aw as R}from"./index-R5OmuXpx.js";class g{constructor(e,t){if(!e.onEnd)throw new Error("onEnd handler is required");if(!t)throw new Error("ms duration is required");this.onEnd=e.onEnd,this.initialMs=t,this.startTimestamp=Date.now(),this.timer=this.create(this.onEnd,t)}create(e,t){return this.timer&&this.clear(),setTimeout(()=>e?e():this.onEnd(),t||this.initialMs)}clear(){clearTimeout(this.timer),this.timer=null}end(){this.clear(),this.onEnd()}isValid(){return this.initialMs-(Date.now()-this.startTimestamp)>0}}class F extends g{constructor(e,t){super(e,t),this.onPause=typeof e.onPause=="function"?e.onPause:()=>{},this.onRefresh=typeof e.onRefresh=="function"?e.onRefresh:()=>{},this.onResume=typeof e.onResume=="function"?e.onResume:()=>{},this.readStorage=e.readStorage,this.remainingMs=void 0,e.refreshEvents||(e.refreshEvents=["click","keydown","scroll"]);try{this.abortController=new AbortController}catch{}if(c&&e.ee){if(e.ee){this.ee=e.ee;const s=S(this.refresh.bind(this),500,{leading:!0});this.refreshHandler=n=>{e.refreshEvents.includes(n?.[0]?.type)&&s()},e.ee.on("fn-end",this.refreshHandler)}p(s=>{s==="hidden"?this.pause():this.resume()},!1,!1,this.abortController?.signal)}}abort(){this.clear(),this.abortController?.abort(),this.refreshHandler&&(this.ee.removeEventListener("fn-end",this.refreshHandler),this.refreshHandler=this.ee=null)}pause(){this.onPause(),clearTimeout(this.timer),this.remainingMs=this.initialMs-(Date.now()-this.startTimestamp)}resume(){try{const t=this.readStorage(),s=typeof t=="string"?JSON.parse(t):t;e(s.expiresAt)||e(s.inactiveAt)?this.end():(this.refresh(),this.onResume())}catch{this.end()}function e(t){return Date.now()>t}}refresh(e,t){this.clear(),this.timer=this.create(e,t),this.startTimestamp=Date.now(),this.remainingMs=void 0,this.onRefresh()}}const h={value:"",inactiveAt:0,expiresAt:0,updatedAt:Date.now(),sessionReplayMode:l.OFF,sessionReplaySentFirstChunk:!1,sessionTraceMode:l.OFF,traceHarvestStarted:!1,loggingMode:A.OFF,serverTimeDiff:null,custom:{},numOfResets:0};class N{constructor(e){const{agentIdentifier:t,key:s,storage:n}=e;if(!t||!s||!n)throw new Error("Missing required field(s):".concat(t?"":" agentID").concat(s?"":" key").concat(n?"":" storage"));this.agentIdentifier=t,this.storage=n,this.state={},this.key=s,this.ee=E.get(t),y(this.ee),this.setup(e),c&&w("storage",r=>{if(r.key===this.lookupKey){const a=typeof r.newValue=="string"?JSON.parse(r.newValue):r.newValue;this.sync(a),this.ee.emit(o.UPDATE,[u.CROSS_TAB,this.state])}})}setup({value:e=T(16),expiresMs:t=M,inactiveMs:s=v,numOfResets:n=0}){const r={serverTimeDiff:this.state.serverTimeDiff||h.serverTimeDiff};this.state={},this.sync({...h,...r}),this.state.value=e,this.expiresMs=t,this.inactiveMs=s;const a=this.read();t?(this.state.expiresAt=a?.expiresAt||this.getFutureTimestamp(t),this.state.numOfResets=a?.numOfResets||n,this.expiresTimer=new g({onEnd:()=>{this.collectSM("expired"),this.collectSM("duration"),this.reset()}},this.state.expiresAt-Date.now())):this.state.expiresAt=1/0,s?(this.state.inactiveAt=a?.inactiveAt||this.getFutureTimestamp(s),this.inactiveTimer=new F({onEnd:()=>{this.collectSM("inactive"),this.collectSM("duration"),this.reset()},onRefresh:this.refresh.bind(this),onResume:()=>{this.ee.emit(o.RESUME)},onPause:()=>{this.initialized&&this.ee.emit(o.PAUSE),this.write(d(this.state,h))},ee:this.ee,refreshEvents:["click","keydown","scroll"],readStorage:()=>this.storage.get(this.lookupKey)},this.state.inactiveAt-Date.now())):this.state.inactiveAt=1/0,this.isNew||=!Object.keys(a).length,this.isNew?this.write(d(this.state,h),!0):this.sync(a),this.initialized=!0,this.ee.emit(o.STARTED,[this.isNew])}get lookupKey(){return"".concat(D,"_").concat(this.key)}sync(e){Object.assign(this.state,e)}read(){try{const e=this.storage.get(this.lookupKey);if(!e)return{};const t=typeof e=="string"?JSON.parse(e):e;return this.isInvalid(t)?{}:this.isExpired(t.expiresAt)?(this.collectSM("expired"),this.collectSM("duration",t,!0),this.reset()):this.isExpired(t.inactiveAt)?(this.collectSM("inactive"),this.collectSM("duration",t,!0),this.reset()):t}catch(e){return m(10,e),{}}}write(e){try{return!e||typeof e!="object"?void 0:(e.updatedAt=Date.now(),this.sync(e),this.storage.set(this.lookupKey,I(this.state)),this.ee.emit(o.UPDATE,[u.SAME_TAB,this.state]),e)}catch(t){return m(11,t),null}}reset(){try{return this.initialized&&(this.ee.emit(o.RESET),this.state.numOfResets++),this.storage.remove(this.lookupKey),this.inactiveTimer?.abort?.(),this.expiresTimer?.clear?.(),delete this.isNew,this.setup({agentIdentifier:this.agentIdentifier,key:this.key,storage:this.storage,expiresMs:this.expiresMs,inactiveMs:this.inactiveMs,numOfResets:this.state.numOfResets}),this.read()}catch{return{}}}refresh(){const e=this.read();this.write({...e,inactiveAt:this.getFutureTimestamp(this.inactiveMs)})}isExpired(e){return Date.now()>e}isInvalid(e){return!Object.keys(h).every(s=>Object.keys(e).includes(s))}collectSM(e,t,s){let n,r;e==="duration"&&(n=this.getDuration(t,s),r="Session/Duration/Ms"),e==="expired"&&(r="Session/Expired/Seen"),e==="inactive"&&(r="Session/Inactive/Seen"),r&&b(O,[r,n],void 0,x.metrics,this.ee)}getDuration(e=this.state,t){const s=e.expiresAt-this.expiresMs;return(t?Date.now():e.updatedAt)-s}getFutureTimestamp(e){return Date.now()+e}syncCustomAttribute(e,t){if(c)if(t===null){const s=this.read();s.custom&&(delete s.custom[e],this.write({...s}))}else{const s=this.read();this.custom={...s?.custom||{},[e]:t},this.write({...s,custom:this.custom})}}}class C{get(e){try{return localStorage.getItem(e)||void 0}catch{return""}}set(e,t){try{return t==null?this.remove(e):localStorage.setItem(e,t)}catch{}}remove(e){try{localStorage.removeItem(e)}catch{}}}function P(i){if(i.runtime.session)return i.runtime.session;const e=i.init.session;i.runtime.session=new N({agentIdentifier:i.agentIdentifier,key:k,storage:new C,expiresMs:e?.expiresMs,inactiveMs:e?.inactiveMs});const t=i.runtime.session.state.custom;t&&(i.info.jsAttributes={...i.info.jsAttributes,...t});const s=E.get(i.agentIdentifier);return f("api-setCustomAttribute",(n,r,a)=>{i.runtime.session.syncCustomAttribute(r,a)},"session",s),f("api-setUserId",(n,r,a)=>{i.runtime.session.syncCustomAttribute(r,a)},"session",s),R(i.agentIdentifier,"session"),i.runtime.session}export{P as setupAgentSession};
//# sourceMappingURL=agent-session-D4HfwFdE.js.map
