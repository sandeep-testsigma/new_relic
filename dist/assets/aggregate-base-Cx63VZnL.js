import{g as d,w as m,f as V,av as j,aw as S,l as z,y as K,a1 as b,a as D,ax as Y,ay as W,az as X,u as Z,aA as $,aB as G,aC as Q,n as J,aD as ee,h as P,c as p,S as I,aE as te,K as se,U as re,aF as ie,aG as ae}from"./index-DDRSPtx0.js";function ne(){return d?.location?.protocol==="file:"}class oe{constructor(e){this.agentRef=e,this.warnedRegexMissing=!1,this.warnedInvalidRegex=!1,this.warnedInvalidReplacement=!1}get obfuscateConfigRules(){return this.agentRef.init.obfuscate||[]}obfuscateString(e){if(typeof e!="string"||e.trim().length===0)return e;const t=this.obfuscateConfigRules.map(r=>this.validateObfuscationRule(r));return ne()&&t.push({regex:/^file:\/\/(.*)/,replacement:atob("ZmlsZTovL09CRlVTQ0FURUQ=")}),t.filter(r=>r.isValid).reduce((r,a)=>{const{rule:i}=a;return r.replace(i.regex,i.replacement||"*")},e)}validateObfuscationRule(e){const t=e.regex===void 0,r=e.regex!==void 0&&typeof e.regex!="string"&&!(e.regex instanceof RegExp),a=!!(e.replacement&&typeof e.replacement!="string");return t&&!this.warnedRegexMissing?(m(12,e),this.warnedRegexMissing=!0):r&&!this.warnedInvalidRegex&&(m(13,e),this.warnedInvalidRegex=!0),a&&!this.warnedInvalidReplacement&&(m(14,e),this.warnedInvalidReplacement=!0),{rule:e,isValid:!t&&!r&&!a,errors:{regexMissingDetected:t,invalidRegexDetected:r,invalidReplacementDetected:a}}}}const He=64e3,ce=1e6,g="NR_CONTAINER_AGENT";class H{constructor(e,t,r,a){this.agentRef=e,this.entityManager=e.runtime.entityManager,this.StorageClass=t,this.appStorageMap=new Map([[g,new this.StorageClass]]),this.featureName=a,this.setEventStore(r)}#e(e=g){return this.appStorageMap.has(e)||this.setEventStore(e),this.appStorageMap.get(e)}setEventStore(e){if(!e)return;const t=V(this.entityManager.get(e),this.agentRef)?this.appStorageMap.get(g):new this.StorageClass;this.appStorageMap.set(e,t)}isEmpty(e,t){if(t)return this.#e(t).isEmpty(e);for(const r of this.appStorageMap.values())if(!r.isEmpty(e))return!1;return!0}add(e,t){return j({agentIdentifier:this.agentRef.agentIdentifier,drained:!!S?.[this.agentRef.agentIdentifier],type:"data",name:"buffer",feature:this.featureName,data:e}),this.#e(t).add(e)}addMetric(e,t,r,a){return this.#e().addMetric(e,t,r,a)}get(e,t){if(t)return[{targetApp:this.entityManager.get(t),data:this.#e(t).get(e)}];const r=[];return this.appStorageMap.forEach((a,i)=>{if(i===g)return;const n=this.entityManager.get(i);n&&r.push({targetApp:n,data:a.get(e)})}),r}byteSize(e){return this.#e(e).byteSize()}wouldExceedMaxSize(e,t){return this.#e(t).wouldExceedMaxSize(e)}save(e,t){if(t)return this.#e(t).save(e);this.appStorageMap.forEach(r=>r.save(e))}clear(e,t){if(t)return this.#e(t).clear(e);this.appStorageMap.forEach(r=>r.clear(e))}reloadSave(e,t){return this.#e(t).reloadSave(e)}clearSave(e,t){return this.#e(t).clearSave(e)}}if(b){d.cleanupTasks=[];const s=d.close;d.close=()=>{for(let e of d.cleanupTasks)e();s()}}function he(s,e){z?K(s,!0,e):b&&d.cleanupTasks.push(s)}var ue=/([^?#]*)[^#]*(#[^?]*|$).*/,fe=/([^?#]*)().*/;function le(s,e){return s.replace(e?ue:fe,"$1$2")}var L={"%2C":",","%3A":":","%2F":"/","%40":"@","%24":"$","%3B":";"},de=Object.keys(L),ge=new RegExp(de.join("|"),"g");function pe(s){return L[s]}function k(s){return s==null?"null":encodeURIComponent(s).replace(ge,pe)}function ve(s,e){var t=0,r="";return Object.entries(s||{}).forEach(([a,i])=>{var n=[],o,c;if(typeof i=="string"||!Array.isArray(i)&&i!==null&&i!==void 0&&i.toString().length)o="&"+a+"="+k(i),t+=o.length,r+=o;else if(Array.isArray(i)&&i.length){for(t+=9,c=0;c<i.length&&(o=k(D(i[c])),t+=o.length,!(typeof e<"u"&&t>=e));c++)n.push(o);r+="&"+a+"=%5B"+n.join(",")+"%5D"}}),r}function f(s,e,t={}){return Object.keys(t).includes(s)?"":e&&typeof e=="string"?"&"+s+"="+k(e):""}function me({isFinalHarvest:s=!1}={}){return s&&z?ye:typeof XMLHttpRequest<"u"?E:w}function w({url:s,body:e=null,method:t="POST",headers:r=[{key:"content-type",value:"text/plain"}]}){const a={};for(const i of r)a[i.key]=i.value;return fetch(s,{headers:a,method:t,body:e,credentials:"include"})}function E({url:s,body:e=null,sync:t,method:r="POST",headers:a=[{key:"content-type",value:"text/plain"}]}){const i=new XMLHttpRequest;i.open(r,s,!t);try{"withCredentials"in i&&(i.withCredentials=!0)}catch{}return a.forEach(n=>{i.setRequestHeader(n.key,n.value)}),i.send(e),i}function ye({url:s,body:e}){try{return window.navigator.sendBeacon.bind(window.navigator)(s,e)}catch{return!1}}const Se="Harvester/Retry/Failed/",be="Harvester/Retry/Succeeded/";class Ee{#e=!1;initializedAggregates=[];constructor(e){this.agentRef=e,he(()=>{this.initializedAggregates.forEach(t=>{typeof t.harvestOpts.beforeUnload=="function"&&t.harvestOpts.beforeUnload()}),this.initializedAggregates.forEach(t=>this.triggerHarvestFor(t,{isFinalHarvest:!0}))},!1)}startTimer(e=this.agentRef.init.harvest.interval){if(this.#e)return;this.#e=!0;const t=()=>{this.initializedAggregates.forEach(r=>this.triggerHarvestFor(r)),setTimeout(t,e*1e3)};setTimeout(t,e*1e3)}triggerHarvestFor(e,t={}){if(e.blocked)return!1;const r=me(t);if(!r)return!1;const a=!t.isFinalHarvest&&r===E;let i,n=!1;if(t.directSend)i=[t.directSend];else if(i=e.makeHarvestPayload(a,t),!i)return!1;return i.forEach(({targetApp:c,payload:h})=>{h&&(xe(this.agentRef,{endpoint:Y[e.featureName],targetApp:c,payload:h,localOpts:t,submitMethod:r,cbFinished:o,raw:e.harvestOpts.raw,featureName:e.featureName}),n=!0)}),n;function o(c){e.harvestOpts.prevAttemptCode&&(P(I,[(c.retry?Se:be)+e.harvestOpts.prevAttemptCode],void 0,p.metrics,e.ee),delete e.harvestOpts.prevAttemptCode),c.retry&&(e.harvestOpts.prevAttemptCode=c.status),t.forceNoRetry&&(c.retry=!1),e.postHarvestCleanup(c)}}}const F={};function xe(s,{endpoint:e,targetApp:t,payload:r,localOpts:a={},submitMethod:i,cbFinished:n,raw:o,featureName:c}){if(!s.info.errorBeacon)return!1;let{body:h,qs:v}=ke(r);if(Object.keys(h).length===0&&!a.sendEmptyBody)return n&&n({sent:!1,targetApp:t}),!1;const l=s.init.ssl===!1?"http":"https",O=s.init.proxy.beacon||s.info.errorBeacon,_=o?"".concat(l,"://").concat(O,"/").concat(e):"".concat(l,"://").concat(O).concat(e!==W?"/"+e:"","/1/").concat(t.licenseKey),R=o?"":we(s,v,e,t.applicationID);let y=ve(v,s.runtime.maxBytes);R===""&&y.startsWith("&")&&(y=y.substring(1));const x="".concat(_,"?").concat(R).concat(y);!!v?.attributes?.includes("gzip")||(e!==X&&(h=D(h)),h.length>75e4&&(F[e]=(F[e]||0)+1)===1&&m(28,e)),(!h||h.length===0||h==="{}"||h==="[]")&&(h="");const T=[{key:"content-type",value:"text/plain"}];let M=i({url:x,body:h,sync:a.isFinalHarvest&&b,headers:T});return!a.isFinalHarvest&&n&&(i===E?M.addEventListener("loadend",function(){const u={sent:this.status!==0,status:this.status,retry:C(this.status),fullUrl:x,xhr:this,targetApp:t};a.needResponse&&(u.responseText=this.responseText),n(u)},Z(!1)):i===w&&M.then(async function(u){const B=u.status,N={sent:!0,status:B,retry:C(B),fullUrl:x,fetchResponse:u,targetApp:t};a.needResponse&&(N.responseText=await u.text()),n(N)})),j({agentIdentifier:s.agentIdentifier,drained:!!S?.[s.agentIdentifier],type:"data",name:"harvest",feature:c,data:{endpoint:e,headers:T,targetApp:t,payload:r,submitMethod:q(),raw:o,synchronousXhr:!!(a.isFinalHarvest&&b)}}),!0;function C(u){switch(u){case 408:case 429:case 500:return!0}return u>=502&&u<=504||u>=512&&u<=530}function q(){return i===E?"xhr":i===w?"fetch":"beacon"}}function ke(s={}){const e=t=>typeof Uint8Array<"u"&&t instanceof Uint8Array||Array.isArray(t)?t:typeof t=="string"?t.length>0?t:null:Object.entries(t||{}).reduce((r,[a,i])=>((typeof i=="number"||typeof i=="string"&&i.length>0||typeof i=="object"&&Object.keys(i||{}).length>0)&&(r[a]=i),r),{});return{body:e(s.body),qs:e(s.qs)}}function we(s,e,t,r){const a=s.runtime.obfuscator.obfuscateString(le(""+d.location)),i=s.runtime.session?.state.sessionReplayMode===1&&t!==$,n=s.runtime.session?.state.sessionTraceMode===1&&![G,Q].includes(t),o=["a="+r,f("sa",s.info.sa?""+s.info.sa:""),f("v",ee),c(),f("ct",s.runtime.customTransaction),"&rst="+J(),"&ck=0","&s="+(s.runtime.session?.state.value||"0"),f("ref",a),f("ptid",s.runtime.ptid?""+s.runtime.ptid:"")];return i&&o.push(f("hr","1",e)),n&&o.push(f("ht","1",e)),o.join("");function c(){return s.info.transactionName?f("to",s.info.transactionName):f("t",s.info.tNamePlain||"Unnamed Transaction")}}class Ae{#e=new Map;#t={};constructor(e){this.agentRef=e,this.#e.set(g,{licenseKey:e.info.licenseKey,applicationID:e.info.applicationID})}get(e=g){return this.#e.get(e)}getEntityGuidFor(e,t){if(!(!this.#t[e]||!this.#t[t]))return this.#t[e].filter(r=>this.#t[t].includes(r))[0]}set(e,t){this.#e.has(e)||(this.#e.set(e,t),this.#t[t.licenseKey]??=[],this.#t[t.licenseKey].push(e),this.#t[t.applicationID]??=[],this.#t[t.applicationID].push(e),this.agentRef.ee.emit("entity-added",[t]))}clear(){this.#e.clear()}setDefaultEntity(e){this.#e.set(g,e)}}class De{#e=[];#t=0;#s;#r;constructor(e=ce){this.maxPayloadSize=e}isEmpty(){return this.#e.length===0}get(){return this.#e}byteSize(){return this.#t}wouldExceedMaxSize(e){return this.#t+e>this.maxPayloadSize}add(e){const t=D(e)?.length||0;return this.#t+t>this.maxPayloadSize?!1:(this.#e.push(e),this.#t+=t,!0)}clear(){this.#e=[],this.#t=0}save(){this.#s=this.#e,this.#r=this.#t}clearSave(){this.#s=void 0,this.#r=void 0}reloadSave(){this.#s&&(this.#r+this.#t>this.maxPayloadSize||(this.#e=[...this.#s,...this.#e],this.#t=this.#r+this.#t))}}class Oe{constructor(){this.aggregatedData={}}store(e,t,r,a,i){var n=this.#e(e,t,r,i);return n.metrics=Re(a,n.metrics),n}merge(e,t,r,a,i,n=!1){var o=this.#e(e,t,a,i);if(n&&(o.params=a),!o.metrics){o.metrics=r;return}var c=o.metrics;c.count+=r.count,Object.keys(r||{}).forEach(h=>{if(h!=="count"){var v=c[h],l=r[h];l&&!l.c?c[h]=A(l.t,v):c[h]=Me(l,c[h])}})}storeMetric(e,t,r,a){var i=this.#e(e,t,r);return i.stats=A(a,i.stats),i}take(e,t=!0){for(var r={},a="",i=!1,n=0;n<e.length;n++)a=e[n],r[a]=Object.values(this.aggregatedData[a]||{}),r[a].length&&(i=!0),t&&delete this.aggregatedData[a];return i?r:null}#e(e,t,r,a){this.aggregatedData[e]||(this.aggregatedData[e]={});var i=this.aggregatedData[e][t];return i||(i=this.aggregatedData[e][t]={params:r||{}},a&&(i.custom=a)),i}}function Re(s,e){return e||(e={count:0}),e.count+=1,Object.entries(s||{}).forEach(([t,r])=>{e[t]=A(r,e[t])}),e}function A(s,e){return s==null?Te(e):e?(e.c||(e=U(e.t)),e.c+=1,e.t+=s,e.sos+=s*s,s>e.max&&(e.max=s),s<e.min&&(e.min=s),e):{t:s}}function Te(s){return s?s.c++:s={c:1},s}function Me(s,e){return e?(e.c||(e=U(e.t)),e.min=Math.min(s.min,e.min),e.max=Math.max(s.max,e.max),e.t+=s.t,e.sos+=s.sos,e.c+=s.c,e):s}function U(s){return{t:s,min:s,max:s,sos:s*s,c:1}}class Ce{#e=new Oe;#t={};isEmpty({aggregatorTypes:e}){return e?e.every(t=>!this.#e.aggregatedData[t]):Object.keys(this.#e.aggregatedData).length===0}add([e,t,r,a,i]){return this.#e.store(e,t,r,a,i),!0}addMetric(e,t,r,a){return this.#e.storeMetric(e,t,r,a),!0}save({aggregatorTypes:e}){const t=e.toString(),r={};e.forEach(a=>r[a]=this.#e.aggregatedData[a]),this.#t[t]=r}get(e){const t=Array.isArray(e)?e:e.aggregatorTypes;return this.#e.take(t,!1)}clear({aggregatorTypes:e}={}){if(!e){this.#e.aggregatedData={};return}e.forEach(t=>delete this.#e.aggregatedData[t])}reloadSave({aggregatorTypes:e}){const t=e.toString(),r=this.#t[t];e.forEach(a=>{Object.keys(r[a]||{}).forEach(i=>{const n=r[a][i];this.#e.merge(a,i,n.metrics,n.params,n.custom,!0)})})}clearSave({aggregatorTypes:e}){const t=e.toString();delete this.#t[t]}}class Fe extends te{constructor(e,t){super(e.agentIdentifier,t),this.agentRef=e,this.checkConfiguration(e),this.doOnceForAllAggregate(e),this.harvestOpts={};const r=this.agentRef?.runtime?.appMetadata?.agents?.[0]?.entityGuid;this.#e(r),r||this.ee.on("entity-added",a=>{this.events?.setEventStore?.(a.entityGuid)})}#e(e){if(!this.events)switch(this.featureName){case p.sessionTrace:case p.sessionReplay:break;case p.jserrors:case p.metrics:this.events=this.agentRef.sharedAggregator??=new H(this.agentRef,Ce,e,"shared_aggregator");break;default:this.events=new H(this.agentRef,De,e,this.featureName);break}}waitForFlags(e=[]){return new Promise((r,a)=>{S[this.agentIdentifier]?r(i(S[this.agentIdentifier])):this.ee.on("rumresp",(n={})=>{r(i(n))});function i(n){return e.map(o=>n[o]?n[o]:0)}}).catch(r=>{this.ee.emit("internal-error",[r]),this.blocked=!0,this.deregisterDrain()})}drain(){se(this.agentIdentifier,this.featureName),this.drained=!0}preHarvestChecks(e){return!this.blocked}makeHarvestPayload(e=!1,t={}){if(!this.events||this.events.isEmpty(this.harvestOpts,t.targetEntityGuid)||this.preHarvestChecks&&!this.preHarvestChecks(t))return;e&&this.events.save(this.harvestOpts,t.targetEntityGuid);const r=this.events.get(this.harvestOpts,t.targetEntityGuid);return r.length?(this.events.clear(this.harvestOpts,t.targetEntityGuid),r.map(({targetApp:a,data:i})=>{const o={body:this.serializer?this.serializer(i,a?.entityGuid):i};return this.queryStringsBuilder&&(o.qs=this.queryStringsBuilder(i,a?.entityGuid)),{targetApp:a,payload:o}})):m(52)}postHarvestCleanup(e={}){e.sent&&e.retry&&this.events.reloadSave(this.harvestOpts,e.targetApp?.entityGuid),this.events.clearSave(this.harvestOpts,e.targetApp?.entityGuid)}checkConfiguration(e){if(!re(e.info)){const t=ie();let r={...t.info?.jsAttributes};try{r={...r,...e.info?.jsAttributes}}catch{}ae(e,{...t,info:{...t.info,jsAttributes:r},runtime:e.runtime},e.runtime.loaderType)}}doOnceForAllAggregate(e){e.runtime.obfuscator||(e.runtime.obfuscator=new oe(e)),this.obfuscator=e.runtime.obfuscator,e.runtime.entityManager||(e.runtime.entityManager=new Ae(this.agentRef)),e.runtime.harvester||(e.runtime.harvester=new Ee(e))}reportSupportabilityMetric(e,t){P(I,[e,t],void 0,p.metrics,this.ee)}}export{Fe as A,De as E,He as I,ce as M,le as c,ne as i,ve as o};
//# sourceMappingURL=aggregate-base-Cx63VZnL.js.map
