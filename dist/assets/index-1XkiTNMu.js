const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/recorder-B9Csk10Y.js","assets/index-DTPXratp.js","assets/index-D8b4DHJx.css","assets/aggregate-base-B87_cqNp.js","assets/stylesheet-evaluator--spz2HHo.js"])))=>i.map(i=>d[i]);
import{P as R,B as s,Q as A,G as u,R as p,T as v,d as S,U as _,c as O,V as w,_ as M,W as E,s as b,w as T,X as g,n as N,Y as C,Z as U}from"./index-DTPXratp.js";import{A as k,M as I,o as L,c as z}from"./aggregate-base-B87_cqNp.js";import{s as B}from"./stylesheet-evaluator--spz2HHo.js";let F;const P=new Promise(y=>{F=y}),D=Object.freeze({onReplayReady:F,sessionReplayInitialized:P});class G extends k{static featureName=R;mode=s.OFF;constructor(e,t){super(e,R),this.initialized=!1,this.blocked=!1,this.gzipper=void 0,this.u8=void 0,this.entitled=!1,this.timeKeeper=void 0,this.recorder=t?.recorder,this.errorNoticed=t?.errorNoticed||!1,this.harvestOpts.raw=!0,this.isSessionTrackingEnabled=A(e.init)&&!!e.runtime.session,this.reportSupportabilityMetric("Config/SessionReplay/Enabled"),this.ee.on(u.RESET,()=>{this.abort(p.RESET)}),this.ee.on(u.PAUSE,()=>{this.recorder?.stopRecording()}),this.ee.on(u.RESUME,()=>{this.recorder&&(this.mode=e.runtime.session.state.sessionReplayMode,!(!this.initialized||this.mode===s.OFF)&&this.recorder?.startRecording())}),this.ee.on(u.UPDATE,(l,d)=>{!this.recorder||!this.initialized||this.blocked||l!==v.CROSS_TAB||(this.mode!==s.OFF&&d.sessionReplayMode===s.OFF&&this.abort(p.CROSS_TAB),this.mode=d.sessionReplayMode)}),S(_.PAUSE,()=>{this.forceStop(this.mode===s.FULL)},this.featureName,this.ee),S(_.ERROR_DURING_REPLAY,l=>{this.handleError(l)},this.featureName,this.ee);const{error_sampling_rate:i,sampling_rate:r,autoStart:n,block_selector:h,mask_text_selector:a,mask_all_inputs:o,inline_images:m,collect_fonts:c}=e.init.session_replay;this.waitForFlags(["srs","sr"]).then(([l,d])=>{if(this.entitled=!!d,!this.entitled){this.deregisterDrain(),this.agentRef.runtime.isRecording&&(this.abort(p.ENTITLEMENTS),this.reportSupportabilityMetric("SessionReplay/EnabledNotEntitled/Detected"));return}this.drain(),this.initializeRecording(l)}).then(()=>{if(this.mode===s.OFF)for(this.recorder?.stopRecording();this.recorder?.getEvents().events.length;)this.recorder?.clearBuffer?.();D.onReplayReady(this.mode)}),n||this.reportSupportabilityMetric("Config/SessionReplay/AutoStart/Modified"),c===!0&&this.reportSupportabilityMetric("Config/SessionReplay/CollectFonts/Modified"),m===!0&&this.reportSupportabilityMetric("Config/SessionReplay/InlineImages/Modifed"),o!==!0&&this.reportSupportabilityMetric("Config/SessionReplay/MaskAllInputs/Modified"),h!=="[data-nr-block]"&&this.reportSupportabilityMetric("Config/SessionReplay/BlockSelector/Modified"),a!=="*"&&this.reportSupportabilityMetric("Config/SessionReplay/MaskTextSelector/Modified"),this.reportSupportabilityMetric("Config/SessionReplay/SamplingRate/Value",r),this.reportSupportabilityMetric("Config/SessionReplay/ErrorSamplingRate/Value",i)}replayIsActive(){return!!(this.recorder&&this.mode===s.FULL&&!this.blocked&&this.entitled)}handleError(e){this.recorder&&(this.recorder.currentBufferTarget.hasError=!0),this.mode===s.ERROR&&O?.document.visibilityState==="visible"&&this.switchToFull()}switchToFull(){!this.entitled||this.blocked||(this.mode=s.FULL,this.recorder&&this.initialized?(this.agentRef.runtime.isRecording||this.recorder.startRecording(),this.syncWithSessionManager({sessionReplayMode:this.mode})):this.initializeRecording(s.FULL,!0))}async initializeRecording(e,t){if(this.initialized=!0,!this.entitled)return;const{session:i,timeKeeper:r}=this.agentRef.runtime;if(this.timeKeeper=r,this.recorder?.parent.trigger===w.API&&this.agentRef.runtime.isRecording?this.mode=s.FULL:!i.isNew&&!t?this.mode=i.state.sessionReplayMode:this.mode=e,this.mode!==s.OFF){if(this.recorder)this.recorder.parent=this;else try{const{Recorder:n}=await M(async()=>{const{Recorder:h}=await import("./recorder-B9Csk10Y.js");return{Recorder:h}},__vite__mapDeps([0,1,2,3,4]));this.recorder=new n(this),this.recorder.currentBufferTarget.hasError=this.errorNoticed}catch{return this.abort(p.IMPORT)}this.mode===s.ERROR&&this.errorNoticed&&(this.mode=s.FULL),this.mode===s.FULL&&this.recorder?.getEvents().type==="preloaded"&&this.prepUtils().then(()=>this.agentRef.runtime.harvester.triggerHarvestFor(this)),await this.prepUtils(),this.agentRef.runtime.isRecording||this.recorder.startRecording(),this.syncWithSessionManager({sessionReplayMode:this.mode})}}async prepUtils(){try{const{gzipSync:e,strToU8:t}=await M(async()=>{const{gzipSync:i,strToU8:r}=await import("./browser-B3O2tql6.js");return{gzipSync:i,strToU8:r}},[]);this.gzipper=e,this.u8=t}catch{}}makeHarvestPayload(e){const t={targetApp:void 0,payload:void 0};if(this.mode!==s.FULL||this.blocked||!this.recorder||!this.timeKeeper?.ready||!this.recorder.hasSeenSnapshot)return;const i=this.recorder.getEvents();if(!i.events.length)return;const r=this.getHarvestContents(i);if(!r.body.length)return this.recorder.clearBuffer(),[t];this.reportSupportabilityMetric("SessionReplay/Harvest/Attempts");let n=0;return this.gzipper&&this.u8?(r.body=this.gzipper(this.u8("[".concat(r.body.map(({__serialized:h,...a})=>{if(a.__newrelic&&h)return h;const o={...a};return o.__newrelic||(o.__newrelic=E(a.timestamp,this.timeKeeper),o.timestamp=this.timeKeeper.correctAbsoluteTimestamp(a.timestamp)),b(o)}).join(","),"]"))),n=r.body.length):(r.body=r.body.map(({__serialized:h,...a})=>{if(a.__newrelic)return a;const o={...a};return o.__newrelic=E(a.timestamp,this.timeKeeper),o.timestamp=this.timeKeeper.correctAbsoluteTimestamp(a.timestamp),o}),n=b(r.body).length),n>I?(this.abort(p.TOO_BIG,n),[t]):(this.agentRef.runtime.session.state.sessionReplaySentFirstChunk||this.syncWithSessionManager({sessionReplaySentFirstChunk:!0}),this.recorder.clearBuffer(),i.type==="preloaded"&&this.agentRef.runtime.harvester.triggerHarvestFor(this),t.payload=r,this.agentRef.runtime.session.state.traceHarvestStarted||T(59,JSON.stringify(this.agentRef.runtime.session.state)),[t])}getCorrectedTimestamp(e){if(e?.timestamp)return e.__newrelic?e.timestamp:this.timeKeeper.correctAbsoluteTimestamp(e.timestamp)}getHarvestContents(e){e??=this.recorder.getEvents();let t=e.events;const i=this.agentRef.runtime,r=this.agentRef.info.jsAttributes?.["enduser.id"];t?.[0]?.type===g.FullSnapshot&&this.recorder.lastMeta&&(e.hasMeta=!0,t.unshift(this.recorder.lastMeta),this.recorder.lastMeta=void 0),t[t.length-1]?.type===g.Meta&&(this.recorder.lastMeta=t[t.length-1],t=t.slice(0,t.length-1),e.hasMeta=!!t.find(f=>f.type===g.Meta));const a=N(),o=this.getCorrectedTimestamp(t[0]),m=this.getCorrectedTimestamp(t[t.length-1]),c=o||Math.floor(this.timeKeeper.correctAbsoluteTimestamp(e.cycleTimestamp)),l=m||Math.floor(this.timeKeeper.correctRelativeTimestamp(a)),d=i.appMetadata?.agents?.[0]||{};return{qs:{browser_monitoring_key:this.agentRef.info.licenseKey,type:"SessionReplay",app_id:this.agentRef.info.applicationID,protocol_version:"0",timestamp:c,attributes:L({...!!this.gzipper&&!!this.u8&&{content_encoding:"gzip"},...d.entityGuid&&{entityGuid:d.entityGuid},harvestId:[i.session?.state.value,i.ptid,i.harvestCount].filter(f=>f).join("_"),"replay.firstTimestamp":c,"replay.lastTimestamp":l,"replay.nodes":t.length,"session.durationMs":i.session.getDuration(),agentVersion:i.version,session:i.session.state.value,rst:a,hasMeta:e.hasMeta||!1,hasSnapshot:e.hasSnapshot||!1,hasError:e.hasError||!1,isFirstChunk:i.session.state.sessionReplaySentFirstChunk===!1,decompressedBytes:e.payloadBytesEstimation,invalidStylesheetsDetected:B.invalidStylesheetsDetected,inlinedAllStylesheets:e.inlinedAllStylesheets,"rrweb.version":U,"payload.type":e.type,...r&&{"enduser.id":this.obfuscator.obfuscateString(r)},currentUrl:this.obfuscator.obfuscateString(z(""+location))},C).substring(1)},body:t}}postHarvestCleanup(e){e.status===429&&this.abort(p.TOO_MANY)}forceStop(e){e&&this.agentRef.runtime.harvester.triggerHarvestFor(this),this.mode=s.OFF,this.recorder?.stopRecording?.(),this.syncWithSessionManager({sessionReplayMode:this.mode})}abort(e={},t){for(T(33,e.message),this.reportSupportabilityMetric("SessionReplay/Abort/".concat(e.sm),t),this.blocked=!0,this.mode=s.OFF,this.recorder?.stopRecording?.(),this.syncWithSessionManager({sessionReplayMode:this.mode}),this.recorder?.clearTimestamps?.();this.recorder?.getEvents().events.length;)this.recorder?.clearBuffer?.()}syncWithSessionManager(e={}){this.isSessionTrackingEnabled&&this.agentRef.runtime.session.write(e)}}export{G as Aggregate};
//# sourceMappingURL=index-1XkiTNMu.js.map
