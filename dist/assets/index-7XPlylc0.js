import{ad as R,O as C,i as D,ae as c,af as S,g as T,n as A,ag as m,ah as g,ai as b,d as a,aj as N,h as l,a as f,$ as P}from"./index-Bqulmxro.js";import{t as w}from"./time-to-first-byte-DXKWJnyk.js";import{c as I,A as x}from"./aggregate-base-C5buiWcF.js";import{g as L,b as r,n as h,a as E}from"./bel-serializer-cLbpUTfr.js";import{n as y}from"./nav-timing-BJJZNqVX.js";import{f as F,a as O}from"./first-paint-DDmO0Pf9.js";let H=0;class U{belType;children=[];start;end;callbackEnd=0;callbackDuration=0;nodeId=++H;constructor(e){this.obfuscator=e.runtime.obfuscator,this.info=e.info}addChild(e){this.children.push(e)}serialize(){}}class M extends U{constructor(e,t){super(e),this.belType=R.AJAX,this.method=t.method,this.status=t.status,this.domain=t.domain,this.path=t.path,this.txSize=t.requestSize,this.rxSize=t.responseSize,this.requestedWith=t.type==="fetch"?1:"",this.spanId=t.spanId,this.traceId=t.traceId,this.spanTimestamp=t.spanTimestamp,this.gql=t.gql,this.start=t.startTime,this.end=t.endTime}serialize(e){const t=L(this.obfuscator),i=[],s=[r(this.belType),0,r(this.start-e),r(this.end-this.start),r(this.callbackEnd),r(this.callbackDuration),t(this.method),r(this.status),t(this.domain),t(this.path),r(this.txSize),r(this.rxSize),this.requestedWith,t(this.nodeId),h(this.spanId,t,!0)+h(this.traceId,t,!0)+h(this.spanTimestamp,r)];let n=[];return typeof this.gql=="object"&&(n=E(this.gql,t)),this.children.forEach(d=>n.push(d.serialize())),s[1]=r(n.length),i.push(s),n.length&&i.push(n.join(";")),i.join(";")}}class p extends U{id=C();initialPageURL=D;customName;customAttributes={};customDataByApi={};queueTime;appTime;newRoute;status=c.IP;domTimestamp=0;historyTimestamp=0;createdByApi=!1;keepOpenUntilEndApi=!1;onDone=[];cancellationTimer;constructor(e,t,i,s,n){super(e),this.belType=R.INTERACTION,this.trigger=t,this.start=i,this.oldRoute=s,this.eventSubscription=new Map([["finished",[]],["cancelled",[]]]),this.forceSave=this.forceIgnore=!1,this.trigger===S&&(this.createdByApi=!0),this.newURL=this.oldURL=n||T?.location.href}updateDom(e){this.domTimestamp=e||A()}updateHistory(e,t){this.newURL=t||""+T?.location,this.historyTimestamp=e||A()}seenHistoryAndDomChange(){return this.historyTimestamp>0&&this.domTimestamp>this.historyTimestamp}on(e,t){if(!this.eventSubscription.has(e))throw new Error("Cannot subscribe to non pre-defined events.");if(typeof t!="function")throw new Error("Must supply function as callback.");this.eventSubscription.get(e).push(t)}done(e){return this.keepOpenUntilEndApi&&e===void 0?!1:(this.status!==c.IP||(this.onDone.forEach(t=>t(this.customDataByApi)),this.forceIgnore?this.#e():this.seenHistoryAndDomChange()?this.#t(e):this.forceSave?this.#t(e||performance.now()):this.#e()),!0)}#t(e=0){clearTimeout(this.cancellationTimer),this.end=Math.max(this.domTimestamp,this.historyTimestamp,e),this.customAttributes={...this.info.jsAttributes,...this.customAttributes},this.status=c.FIN,this.eventSubscription.get("finished").forEach(i=>i())}#e(){clearTimeout(this.cancellationTimer),this.status=c.CAN,this.eventSubscription.get("cancelled").forEach(t=>t())}isActiveDuring(e){return this.status===c.IP?this.start<=e:this.status===c.FIN&&this.start<=e&&this.end>e}get firstPaint(){}get firstContentfulPaint(){}get navTiming(){}serialize(e){const t=e===void 0,i=L(this.obfuscator),s=[];let n;this.trigger===m?n=g.INITIAL_PAGE_LOAD:this.newURL!==this.oldURL?n=g.ROUTE_CHANGE:n=g.UNSPECIFIED;const d=[r(this.belType),0,r(this.start-(t?0:e)),r(this.end-this.start),r(this.callbackEnd),r(this.callbackDuration),i(this.trigger),i(I(this.initialPageURL,!0)),i(I(this.oldURL,!0)),i(I(this.newURL,!0)),i(this.customName),n,h(this.queueTime,r,!0)+h(this.appTime,r,!0)+h(this.oldRoute,i,!0)+h(this.newRoute,i,!0)+i(this.id),i(this.nodeId),h(this.firstPaint,r,!0)+h(this.firstContentfulPaint,r)],u=E(this.customAttributes||{},i);return this.info.atts&&u.push("a,"+i(this.info.atts)),this.children.forEach(v=>u.push(v.serialize(t?this.start:e))),d[1]=r(u.length),s.push(d),u.length&&s.push(u.join(";")),this.navTiming?s.push(this.navTiming):s.push(""),s.join(";")}}class _ extends p{constructor(e){super(e,m,0,null),this.queueTime=e.info.queueTime,this.appTime=e.info.applicationTime,this.oldURL=document.referrer}get firstPaint(){return F.current.value}get firstContentfulPaint(){return O.current.value}get navTiming(){if(!y.length)return;let e=",",t="b",i=0;return y.slice(1,21).forEach(s=>{s!==void 0?(t+=e+r(s-i),e=",",i=s):(t+=e+"!",e="")}),t}}class J extends x{static featureName=b;constructor(e,{domObserver:t}){super(e,b),this.interactionsToHarvest=this.events,this.domObserver=t,this.initialPageLoadInteraction=new _(e),this.initialPageLoadInteraction.onDone.push(()=>{e.runtime.session?.isNew&&(this.initialPageLoadInteraction.customAttributes.isFirstOfSession=!0),this.initialPageLoadInteraction.forceSave=!0;const i=this.initialPageLoadInteraction;this.interactionsToHarvest.add(i),this.initialPageLoadInteraction=null}),w.subscribe(({attrs:i})=>{const s=i.navigationEntry.loadEventEnd;this.initialPageLoadInteraction.done(s),this.reportSupportabilityMetric("SoftNav/Interaction/InitialPageLoad/Duration/Ms",Math.round(s))}),this.latestRouteSetByApi=null,this.interactionInProgress=null,this.latestHistoryUrl=null,this.harvestOpts.beforeUnload=()=>this.interactionInProgress?.done(),this.waitForFlags(["spa"]).then(([i])=>{i?(this.drain(),setTimeout(()=>e.runtime.harvester.triggerHarvestFor(this),0)):(this.blocked=!0,this.deregisterDrain())}),a("newUIEvent",i=>this.startUIInteraction(i.type,Math.floor(i.timeStamp),i.target),this.featureName,this.ee),a("newURL",(i,s)=>{this.latestHistoryUrl=s,this.interactionInProgress?.updateHistory(i,s)},this.featureName,this.ee),a("newDom",i=>{this.interactionInProgress?.updateDom(i),this.interactionInProgress?.seenHistoryAndDomChange()&&this.interactionInProgress.done()},this.featureName,this.ee),this.#i(),a("ajax",this.#t.bind(this),this.featureName,this.ee),a("jserror",this.#e.bind(this),this.featureName,this.ee)}serializer(e){let t;const i=[];for(const s of e)i.push(s.serialize(t)),t===void 0&&(t=Math.floor(s.start));return`bel.7;${i.join(";")}`}startUIInteraction(e,t,i){if(this.interactionInProgress?.createdByApi||this.interactionInProgress?.done()===!1)return;const s=e===N[3]?this.latestHistoryUrl:void 0;if(this.interactionInProgress=new p(this.agentRef,e,t,this.latestRouteSetByApi,s),e===N[0]){const n=z(i);n&&(this.interactionInProgress.customAttributes.actionText=n)}this.interactionInProgress.cancellationTimer=setTimeout(()=>{this.interactionInProgress.done(),this.reportSupportabilityMetric("SoftNav/Interaction/TimeOut")},3e4),this.setClosureHandlers()}setClosureHandlers(){this.interactionInProgress.on("finished",()=>{const e=this.interactionInProgress;this.interactionsToHarvest.add(this.interactionInProgress),this.interactionInProgress=null,this.domObserver.disconnect(),this.reportSupportabilityMetric(`SoftNav/Interaction/${e.newURL!==e.oldURL?"RouteChange":"Custom"}/Duration/Ms`,Math.round(e.end-e.start))}),this.interactionInProgress.on("cancelled",()=>{this.interactionInProgress=null,this.domObserver.disconnect()})}getInteractionFor(e){if(this.interactionInProgress?.isActiveDuring(e))return this.interactionInProgress;let t;const[{data:i}]=this.interactionsToHarvest.get();for(let s=i.length-1;s>=0;s--){const n=i[s];if(n.isActiveDuring(e)){if(n.trigger!==m)return n;t=n}}if(t)return t;if(this.initialPageLoadInteraction?.isActiveDuring(e))return this.initialPageLoadInteraction}#t(e){const t=this.getInteractionFor(e.startTime);t?t.status===c.FIN?i(this.agentRef,e,t):(t.on("finished",()=>i(this.agentRef,e,t)),t.on("cancelled",()=>l("returnAjax",[e],void 0,f.ajax,this.ee))):l("returnAjax",[e],void 0,f.ajax,this.ee);function i(s,n,d){const u=new M(s,n);d.addChild(u)}}#e(e,t){const i=this.getInteractionFor(t);i&&(e.browserInteractionId=i.id,i.status===c.FIN?(e._softNavFinished=!0,e._softNavAttributes=i.customAttributes):(i.on("finished",P(()=>l("softNavFlush",[i.id,!0,i.customAttributes],void 0,f.jserrors,this.ee))),i.on("cancelled",P(()=>l("softNavFlush",[i.id,!1,void 0],void 0,f.jserrors,this.ee)))))}#i(){const e="api-ixn-",t=this;a(e+"get",function(i,{waitForEnd:s}={}){this.associatedInteraction=t.getInteractionFor(i),this.associatedInteraction?.trigger===m&&(this.associatedInteraction=null),this.associatedInteraction||(this.associatedInteraction=t.interactionInProgress=new p(t.agentRef,S,i,t.latestRouteSetByApi),t.domObserver.observe(document.body,{attributes:!0,childList:!0,subtree:!0,characterData:!0}),t.setClosureHandlers()),s===!0&&(this.associatedInteraction.keepOpenUntilEndApi=!0)},t.featureName,t.ee),a(e+"end",function(i){this.associatedInteraction.done(i)},t.featureName,t.ee),a(e+"save",function(){this.associatedInteraction.forceSave=!0},t.featureName,t.ee),a(e+"ignore",function(){this.associatedInteraction.forceIgnore=!0},t.featureName,t.ee),a(e+"getContext",function(i,s){typeof s=="function"&&setTimeout(()=>s(this.associatedInteraction.customDataByApi),0)},t.featureName,t.ee),a(e+"onEnd",function(i,s){typeof s=="function"&&this.associatedInteraction.onDone.push(s)},t.featureName,t.ee),a(e+"actionText",function(i,s){s&&(this.associatedInteraction.customAttributes.actionText=s)},t.featureName,t.ee),a(e+"setName",function(i,s,n){s&&(this.associatedInteraction.customName=s),n&&(this.associatedInteraction.trigger=n)},t.featureName,t.ee),a(e+"setAttribute",function(i,s,n){this.associatedInteraction.customAttributes[s]=n},t.featureName,t.ee),a(e+"routeName",function(i,s){t.latestRouteSetByApi=s,t.interactionInProgress&&(t.interactionInProgress.newRoute=s)},t.featureName,t.ee)}}function z(o){const e=o.tagName.toLowerCase();if(["a","button","input"].includes(e))return o.title||o.value||o.innerText}export{J as Aggregate};
//# sourceMappingURL=index-7XPlylc0.js.map
