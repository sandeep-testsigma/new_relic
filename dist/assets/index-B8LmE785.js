import{M as y,B as o,n as E,g as l,D as O,E as R,G as v,d as u,w}from"./index-B3G9PyXW.js";import{A,o as M,c as F}from"./aggregate-base-CDb8COIg.js";import{e as p}from"./event-origin-Bb7irpQQ.js";import{a as k}from"./traverse-eGeoT8Mx.js";class f{constructor(e,i,s,t,r){this.n=e,this.s=i,this.e=s,this.o=t,this.t=r}}const N=30*1e3,_=typeof l.PerformanceObserver=="function",m={global:{mouseup:!0,mousedown:!0,mousemove:!0},window:{load:!0,pagehide:!0},xhrOriginMissing:{ignoreAll:!0}},d={typing:[1e3,2e3],scrolling:[100,1e3],mousing:[1e3,2e3],touching:[1e3,2e3]};class L{nodeCount=0;trace={};earliestTimeStamp=1/0;latestTimeStamp=0;prevStoredEvents=new Set;#s;constructor(e){this.parent=e}#e(){return!(this.parent.blocked||this.nodeCount>=y&&(this.parent.mode!==o.ERROR||this.trimSTNs(N)===0))}#t(e){this.trace[e.n]?this.trace[e.n].push(e):this.trace[e.n]=[e],e.s<this.earliestTimeStamp&&(this.earliestTimeStamp=e.s),e.s>this.latestTimeStamp&&(this.latestTimeStamp=e.s),this.nodeCount++}trimSTNs(e){let i=0;const s=Math.max(E()-e,0);return Object.keys(this.trace).forEach(t=>{const r=this.trace[t];let n=r.findIndex(a=>s<=a.e);n!==0&&(n<0?(n=r.length,delete this.trace[t]):r.splice(0,n),this.nodeCount-=n,i+=n)}),i}takeSTNs(){_||this.storeResources(l.performance?.getEntriesByType?.("resource"));const e=Object.entries(this.trace).flatMap(([t,r])=>{if(!(t in d))return r;const n=this.smearEvtsByOrigin(t),a=r.sort((h,c)=>h.s-c.s).reduce(n,{});return Object.values(a).flat()},this),i=this.earliestTimeStamp,s=this.latestTimeStamp;return{stns:e,earliestTimeStamp:i,latestTimeStamp:s}}smearEvtsByOrigin(e){const i=d[e][0],s=d[e][1],t={};return(n,a)=>{let h=n[a.o];h||(h=n[a.o]=[]);const c=t[a.o];return e==="scrolling"&&!r(a)?(t[a.o]=null,a.n="scroll",h.push(a)):c&&a.s-c.s<s&&c.e>a.s-i?c.e=a.e:(t[a.o]=a,h.push(a)),n};function r(n){return!!(n&&typeof n.e=="number"&&typeof n.s=="number"&&n.e-n.s<4)}}storeNode(e){this.#e()&&this.#t(e)}processPVT(e,i,s){this.storeTiming({[e]:i})}storeTiming(e,i=!1){if(e)for(let s in e){let t=e[s];const r=s.toLowerCase();if(!(r.indexOf("size")>=0||r.indexOf("status")>=0)&&typeof t=="number"&&t>=0){if(t=Math.round(t),this.parent.timeKeeper&&this.parent.timeKeeper.ready&&i&&(t=this.parent.timeKeeper.convertAbsoluteTimestamp(Math.floor(this.parent.timeKeeper.correctAbsoluteTimestamp(t)))),!this.#e())return;this.#t(new f(s,t,t,"document","timing"))}}}storeEvent(e,i,s,t){if(this.shouldIgnoreEvent(e,i)||!this.#e()||this.prevStoredEvents.has(e))return;this.prevStoredEvents.add(e);const r=new f(this.evtName(e.type),s,t,void 0,"event");try{r.o=p(e.target,i,this.parent.ee)}catch{r.o=p(null,i,this.parent.ee)}this.#t(r)}shouldIgnoreEvent(e,i){if(e.type in m.global)return!0;const s=p(e.target,i,this.parent.ee);return m[s]&&m[s].ignoreAll?!0:!!(m[s]&&e.type in m[s])}evtName(e){switch(e){case"keydown":case"keyup":case"keypress":return"typing";case"mousemove":case"mouseenter":case"mouseleave":case"mouseover":case"mouseout":return"mousing";case"scroll":return"scrolling";case"touchstart":case"touchmove":case"touchend":case"touchcancel":case"touchenter":case"touchleave":return"touching";default:return e}}storeHist(e,i,s){this.#e()&&this.#t(new f("history.pushState",s,s,e,i))}#i=0;storeResources(e){if(!(!e||e.length===0)){for(let i=0;i<e.length;i++){const s=e[i];if((s.fetchStart|0)<=this.#i)continue;if(!this.#e())break;const{initiatorType:t,fetchStart:r,responseEnd:n,entryType:a}=s,{protocol:h,hostname:c,port:T,pathname:S}=O(s.name),b=new f(t,r|0,n|0,"".concat(h,"://").concat(c,":").concat(T).concat(S),a);this.#t(b)}this.#i=e[e.length-1].fetchStart|0}}storeErrorAgg(e,i,s,t){e==="err"&&this.#e()&&this.#t(new f("error",t.time,t.time,s.message,s.stackHash))}storeXhrAgg(e,i,s,t){e==="xhr"&&this.#e()&&this.#t(new f("Ajax",t.time,t.time+t.duration,"".concat(s.status," ").concat(s.method,": ").concat(s.host).concat(s.pathname),"ajax"))}isEmpty(){return this.nodeCount===0}save(){this.#s=this.trace}get(){return[{targetApp:this.parent.agentRef.runtime.entityManager.get(),data:this.takeSTNs()}]}clear(){this.trace={},this.nodeCount=0,this.prevStoredEvents.clear(),this.earliestTimeStamp=1/0,this.latestTimeStamp=0}reloadSave(){for(const e of Object.values(this.#s))for(const i of e){if(!this.#e())return;this.#t(i)}}clearSave(){this.#s=void 0}}const I=30*1e3,D=5e3;class K extends A{static featureName=R;constructor(e){super(e,R),this.harvestOpts.raw=!0,this.entitled=void 0,this.everHarvested=!1,this.harvesting=!1,this.events=new L(this),this.waitForFlags(["sts","st"]).then(([i,s])=>this.initialize(i,s))}initialize(e,i,s){if(this.entitled??=i,this.entitled||(this.blocked=!0),this.blocked)return this.deregisterDrain();if(this.initialized||(this.initialized=!0,this.ptid=this.agentRef.runtime.ptid,this.sessionId=this.agentRef.runtime.session?.state.value,this.ee.on(v.RESET,()=>{this.blocked||this.abort(1)}),this.ee.on(v.UPDATE,(t,r)=>{this.blocked||(this.mode!==o.FULL&&(r.sessionReplayMode===o.FULL||r.sessionTraceMode===o.FULL)&&this.switchToFull(),(this.sessionId!==r.value||t==="cross-tab"&&r.sessionTraceMode===o.OFF)&&this.abort(2))}),typeof PerformanceNavigationTiming<"u"?this.events.storeTiming(l.performance?.getEntriesByType?.("navigation")[0]):this.events.storeTiming(l.performance?.timing,!0)),!this.agentRef.runtime.session.isNew&&!s?this.mode=this.agentRef.runtime.session.state.sessionTraceMode:this.mode=e,this.mode===o.OFF)return this.deregisterDrain();this.timeKeeper??=this.agentRef.runtime.timeKeeper,u("bst",(...t)=>this.events.storeEvent(...t),this.featureName,this.ee),u("bstResource",(...t)=>this.events.storeResources(...t),this.featureName,this.ee),u("bstHist",(...t)=>this.events.storeHist(...t),this.featureName,this.ee),u("bstXhrAgg",(...t)=>this.events.storeXhrAgg(...t),this.featureName,this.ee),u("bstApi",(...t)=>this.events.storeNode(...t),this.featureName,this.ee),u("trace-jserror",(...t)=>this.events.storeErrorAgg(...t),this.featureName,this.ee),u("pvtAdded",(...t)=>this.events.processPVT(...t),this.featureName,this.ee),this.mode!==o.FULL&&u("trace-jserror",()=>{this.mode===o.ERROR&&this.switchToFull()},this.featureName,this.ee),this.agentRef.runtime.session.write({sessionTraceMode:this.mode}),this.drain(),this.agentRef.runtime.harvester.triggerHarvestFor(this)}preHarvestChecks(){if(!(this.blocked||this.mode!==o.FULL)&&this.timeKeeper?.ready&&this.agentRef.runtime.session){if(this.sessionId!==this.agentRef.runtime.session.state.value||this.ptid!==this.agentRef.runtime.ptid){this.abort(3);return}return!0}}serializer({stns:e}){if(e.length)return this.everHarvested=!0,k(e,this.obfuscator.obfuscateString.bind(this.obfuscator),"string")}queryStringsBuilder({stns:e,earliestTimeStamp:i,latestTimeStamp:s}){const t=!this.agentRef.runtime.session.state.traceHarvestStarted;t&&this.agentRef.runtime.session.write({traceHarvestStarted:!0});const r=this.agentRef.runtime.session.state.sessionReplayMode===1,n=this.agentRef.info.jsAttributes["enduser.id"],a=this.agentRef.runtime.appMetadata.agents?.[0]?.entityGuid;return{browser_monitoring_key:this.agentRef.info.licenseKey,type:"BrowserSessionChunk",app_id:this.agentRef.info.applicationID,protocol_version:"0",timestamp:Math.floor(this.timeKeeper.correctRelativeTimestamp(i)),attributes:M({...a&&{entityGuid:a},harvestId:"".concat(this.agentRef.runtime.session.state.value,"_").concat(this.agentRef.runtime.ptid,"_").concat(this.agentRef.runtime.harvestCount),"trace.firstTimestamp":Math.floor(this.timeKeeper.correctRelativeTimestamp(i)),"trace.lastTimestamp":Math.floor(this.timeKeeper.correctRelativeTimestamp(s)),"trace.nodes":e.length,"trace.originTimestamp":this.timeKeeper.correctedOriginTime,agentVersion:this.agentRef.runtime.version,...t&&{firstSessionHarvest:t},...r&&{hasReplay:r},ptid:"".concat(this.ptid),session:"".concat(this.sessionId),...n&&{"enduser.id":this.obfuscator.obfuscateString(n)},currentUrl:this.obfuscator.obfuscateString(F(""+location))},D).substring(1)}}switchToFull(){if(this.mode===o.FULL||!this.entitled||this.blocked)return;const e=this.mode;if(this.mode=o.FULL,this.agentRef.runtime.session.write({sessionTraceMode:this.mode}),e===o.OFF||!this.initialized)return this.initialize(this.mode,this.entitled);this.initialized&&(this.events.trimSTNs(I),this.agentRef.runtime.harvester.triggerHarvestFor(this))}abort(e){w(60,e),this.blocked=!0,this.mode=o.OFF,this.agentRef.runtime.session.write({sessionTraceMode:this.mode}),this.events.clear()}}export{K as Aggregate};
//# sourceMappingURL=index-B8LmE785.js.map
