import{v as C,x as E,d as I,s as g,F as S,w as T,n as O,c as F,e as M,l as w}from"./index-DTPXratp.js";import{c as A,A as H}from"./aggregate-base-B87_cqNp.js";import{a as P}from"./traverse-eGeoT8Mx.js";const L=/([a-z0-9]+)$/i;function B(r){if(!r)return;const e=r.match(L);if(e)return e[1]}var $=/^\n+|\n+$/g,N=65530;function z(r){return W(r).replace($,"")}function W(r){var e;if(r.length>100){var t=r.length-100;e=r.slice(0,50).join(`
`),e+=`
< ...truncated `+t+` lines... >
`,e+=r.slice(-50).join(`
`)}else e=r.join(`
`);return e}function q(r){return r.length>N?r.substr(0,N):r}function y(r){if(typeof r!="string")return"";const e=A(r),t=A(C);return e===t?"<inline>":e}var D=/function (.+?)\s*\(/,K=/^\s*at (?:((?:\[object object\])?(?:[^(]*\([^)]*\))*[^()]*(?: \[as \S+\])?) )?\(?((?:file|http|https|chrome-extension):.*?)?:(\d+)(?::(\d+))?\)?\s*$/i,Y=/^\s*(?:(\S*|global code)(?:\(.*?\))?@)?((?:file|http|https|chrome|safari-extension).*?):(\d+)(?::(\d+))?\s*$/i,J=/^\s*at .+ \(eval at \S+ \((?:(?:file|http|https):[^)]+)?\)(?:, [^:]*:\d+:\d+)?\)$/i,V=/^\s*at Function code \(Function code:\d+:\d+\)\s*/i;function X(r){var e=null;try{if(e=G(r),e)return e}catch{}try{if(e=x(r),e)return e}catch{}try{if(e=ee(r),e)return e}catch{}return{mode:"failed",stackString:"",frames:[]}}function G(r){if(!r.stack)return null;var e=r.stack.split(`
`).reduce(Q,{frames:[],stackLines:[],wrapperSeen:!1});return e.frames.length?{mode:"stack",name:r.name||R(r),message:r.message,stackString:z(e.stackLines),frames:e.frames}:null}function Q(r,e){let t=Z(e);if(!t)return r.stackLines.push(e),r;if(re(t.func)&&(r.wrapperSeen=!0),!r.wrapperSeen){let s=y(t.url);s!==t.url&&(e=e.replace(t.url,s),t.url=s),r.stackLines.push(e),r.frames.push(t)}return r}function Z(r){var e=r.match(Y);if(e||(e=r.match(K)),e)return{url:e[2],func:e[1]!=="Anonymous function"&&e[1]!=="global code"&&e[1]||null,line:+e[3],column:e[4]?+e[4]:null};if(r.match(J)||r.match(V)||r==="anonymous")return{func:"evaluated code"}}function x(r){if(!("line"in r))return null;var e=r.name||R(r);if(!r.sourceURL)return{mode:"sourceline",name:e,message:r.message,stackString:e+": "+r.message+`
    in evaluated code`,frames:[{func:"evaluated code"}]};var t=y(r.sourceURL),s=e+": "+r.message+`
    at `+t;return r.line&&(s+=":"+r.line,r.column&&(s+=":"+r.column)),{mode:"sourceline",name:e,message:r.message,stackString:s,frames:[{url:t,line:r.line,column:r.column}]}}function ee(r){var e=r.name||R(r);return e?{mode:"nameonly",name:e,message:r.message,stackString:e+": "+r.message,frames:[]}:null}function R(r){var e=D.exec(String(r.constructor));return e&&e.length>1?e[1]:"unknown"}function re(r){return r&&r.indexOf("nrWrapper")>=0}function b(r){var e=0,t;if(!r||!r.length)return e;for(var s=0;s<r.length;s++)t=r.charCodeAt(s),e=(e<<5)-e+t,e=e|0;return e}const _="Rrweb",k="Security-Policy";function te(r,e,t){const s={shouldSwallow:e||!1,reason:t||"Other"},n=r.frames?.[0];if(!n||typeof r?.message!="string")return s;const u=n?.url?.match(/nr-(.*)-recorder.min.js/),o=n?.url?.match(/rrweb/),l=n?.url?.match(/recorder/),f=r.message.toLowerCase().match(/an attempt was made to break through the security policy of the user agent/);return u||o?(s.shouldSwallow=!0,s.reason=_,f&&(s.reason+="-"+k)):l&&f&&(s.shouldSwallow=!0,s.reason=_+"-"+k),s}class oe extends H{static featureName=E;constructor(e){super(e,E),this.stackReported={},this.observedAt={},this.pageviewReported={},this.bufferedErrorsUnderSpa={},this.errorOnPage=!1,this.ee.on("interactionDone",(t,s)=>this.onInteractionDone(t,s)),I("err",(...t)=>this.storeError(...t),this.featureName,this.ee),I("ierr",(...t)=>this.storeError(...t),this.featureName,this.ee),I("softNavFlush",(t,s,n)=>this.onSoftNavNotification(t,s,n),this.featureName,this.ee),this.harvestOpts.aggregatorTypes=["err","ierr","xhr"],this.waitForFlags(["err"]).then(([t])=>{t?this.drain():(this.blocked=!0,this.deregisterDrain())})}serializer(e){return P(e,this.obfuscator.obfuscateString.bind(this.obfuscator),"string")}queryStringsBuilder(e){const t={},s=g(this.agentRef.runtime.releaseIds);return s!=="{}"&&(t.ri=s),e?.err?.length&&(this.errorOnPage||(t.pve="1",this.errorOnPage=!0),this.agentRef.features?.[S.sessionReplay]?.featAggregate?.replayIsActive()||e.err.forEach(n=>delete n.params.hasReplay)),t}buildCanonicalStackString(e){for(var t="",s=0;s<e.frames.length;s++){var n=e.frames[s],u=B(n.func);t&&(t+=`
`),u&&(t+=u+"@"),typeof n.url=="string"&&(t+=n.url),n.line&&(t+=":"+n.line)}return t}storeError(e,t,s,n,u,o,l){if(!e)return;const f=this.agentRef.runtime.entityManager.get(l);if(!f)return T(56,this.featureName);t=t||O();let h;if(!s&&this.agentRef.runtime.onerror&&(h=this.agentRef.runtime.onerror(e),h&&!(typeof h.group=="string"&&h.group.length)))return;var c=X(e);const{shouldSwallow:m,reason:d}=te(c,s,o);if(m){this.reportSupportabilityMetric("Internal/Error/"+d);return}var v=this.buildCanonicalStackString(c);const a={stackHash:b(v),exceptionClass:c.name,request_uri:F?.location.pathname};c.message&&(a.message=""+c.message),h?.group&&(a.errorGroup=h.group),u&&M(f,this.agentRef)&&(a.hasReplay=u);var i=b("".concat(c.name,"_").concat(c.message,"_").concat(c.stackString,"_").concat(a.hasReplay?1:0));this.stackReported[i]?a.browser_stack_hash=b(c.stackString):(this.stackReported[i]=!0,a.stack_trace=q(c.stackString),this.observedAt[i]=Math.floor(this.agentRef.runtime.timeKeeper.correctRelativeTimestamp(t))),a.releaseIds=g(this.agentRef.runtime.releaseIds),this.pageviewReported[i]||(a.pageview=1,this.pageviewReported[i]=!0),a.firstOccurrenceTimestamp=this.observedAt[i],a.timestamp=Math.floor(this.agentRef.runtime.timeKeeper.correctRelativeTimestamp(t));var U="err",j={time:t};const p=[U,i,a,j,n];this.shouldAllowMainAgentToCapture(l)&&w("trace-jserror",p,void 0,S.sessionTrace,this.ee),!this.blocked&&(e?.__newrelic?.[this.agentIdentifier]&&(a._interactionId=e.__newrelic[this.agentIdentifier].interactionId,a._interactionNodeId=e.__newrelic[this.agentIdentifier].interactionNodeId),this.shouldAllowMainAgentToCapture(l)&&(!!this.agentRef.features?.[S.softNav]?w("jserror",[a,t],void 0,S.softNav,this.ee):w("spa-jserror",p,void 0,S.spa,this.ee),a.browserInteractionId&&!a._softNavFinished?(this.bufferedErrorsUnderSpa[a.browserInteractionId]??=[],this.bufferedErrorsUnderSpa[a.browserInteractionId].push(p)):a._interactionId!=null?(this.bufferedErrorsUnderSpa[a._interactionId]=this.bufferedErrorsUnderSpa[a._interactionId]||[],this.bufferedErrorsUnderSpa[a._interactionId].push(p)):this.#e(p,a.browserInteractionId!==void 0,a._softNavAttributes)),l&&this.#e([...p,l],!1,a._softNavAttributes))}#e(e,t,s={}){let[n,u,o,l,f,h]=e;const c={};t?(Object.entries(s).forEach(([a,i])=>v(a,i)),u+=o.browserInteractionId,delete o._softNavAttributes,delete o._softNavFinished):(Object.entries(this.agentRef.info.jsAttributes).forEach(([a,i])=>v(a,i)),delete o.browserInteractionId),f&&Object.entries(f).forEach(([a,i])=>v(a,i));const m=b(g(c)),d=u+":"+m;this.events.add([n,d,o,l,c],h);function v(a,i){c[a]=i&&typeof i=="object"?g(i):i}}shouldAllowMainAgentToCapture(e){return!e||this.agentRef.init.api.duplicate_registered_data}onInteractionDone(e,t){!this.bufferedErrorsUnderSpa[e.id]||this.blocked||(this.bufferedErrorsUnderSpa[e.id].forEach(s=>{var n={};const u=s[4];Object.entries(e.root.attrs.custom||{}).forEach(c),Object.entries(u||{}).forEach(c);var o=s[2];t&&(o.browserInteractionId=e.root.attrs.id,o._interactionNodeId&&(o.parentNodeId=o._interactionNodeId.toString())),delete o._interactionId,delete o._interactionNodeId;var l=t?s[1]+e.root.attrs.id:s[1],f=b(g(n)),h=l+":"+f;this.events.add([s[0],h,o,s[3],n],s[5]);function c([m,d]){n[m]=d&&typeof d=="object"?g(d):d}}),delete this.bufferedErrorsUnderSpa[e.id])}onSoftNavNotification(e,t,s){this.blocked||(this.bufferedErrorsUnderSpa[e]?.forEach(n=>this.#e(n,t,s)),delete this.bufferedErrorsUnderSpa[e])}}export{oe as Aggregate};
//# sourceMappingURL=index-BGThSWpe.js.map
