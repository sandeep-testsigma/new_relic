import{N as R,c as o,Q as f,T as d,d as b,U as E,w as c,l as w,g as h,a as g,n as p,f as y,V as B}from"./index-BU7ycNNo.js";import{a as T,b as l}from"./nav-timing-BJJZNqVX.js";import{A as N}from"./aggregate-base-C_iCLCUb.js";import{f as D,a as F}from"./first-paint-CGGyxHZy.js";import{t as M}from"./time-to-first-byte-CuzK1dai.js";import{a as S}from"./traverse-eGeoT8Mx.js";function A(u){const e=[],r=R();try{Object.keys(r.initializedAgents[u].features).forEach(t=>{switch(t){case o.ajax:e.push("xhr");break;case o.jserrors:e.push("err");break;case o.genericEvents:e.push("ins");break;case o.sessionTrace:e.push("stn");break;case o.softNav:case o.spa:e.push("spa");break}})}catch{}return e}class x{#r;#t;#e;#i=!1;constructor(e){this.#r=e,this.processStoredDiff()}get ready(){return this.#i}get correctedOriginTime(){return this.#t}get localTimeDiff(){return this.#e}processRumRequest(e,r,t,i){if(this.processStoredDiff(),this.#i)return;if(!i)throw new Error("nrServerTime not found");const s=(t-r)/2,n=r+s;if(this.#t=Math.floor(i-n),this.#e=f-this.#t,isNaN(this.#t))throw new Error("Failed to correct browser time to server time");this.#r?.write({serverTimeDiff:this.#e}),this.#i=!0}convertRelativeTimestamp(e){return f+e}convertAbsoluteTimestamp(e){return e-f}correctAbsoluteTimestamp(e){return e-this.#e}correctRelativeTimestamp(e){return this.correctAbsoluteTimestamp(this.convertRelativeTimestamp(e))}processStoredDiff(){if(this.#i)return;const e=this.#r?.read()?.serverTimeDiff;typeof e=="number"&&!isNaN(e)&&(this.#e=e,this.#t=f-this.#e,this.#i=!0)}}class P extends N{static featureName=d;constructor(e){if(super(e,d),this.timeToFirstByte=0,this.firstByteToWindowLoad=0,this.firstByteToDomContent=0,b("send-rum",(r,t)=>{this.sendRum(r,t)},this.featureName,this.ee),!E(e.info))return this.ee.abort(),c(43);e.runtime.timeKeeper=new x(e.runtime.session),w?M.subscribe(({value:r,attrs:t})=>{const i=t.navigationEntry;this.timeToFirstByte=Math.max(r,this.timeToFirstByte),this.firstByteToWindowLoad=Math.max(Math.round(i.loadEventEnd-this.timeToFirstByte),this.firstByteToWindowLoad),this.firstByteToDomContent=Math.max(Math.round(i.domContentLoadedEventEnd-this.timeToFirstByte),this.firstByteToDomContent),this.sendRum()}):this.sendRum()}sendRum(e=this.agentRef.info.jsAttributes,r={licenseKey:this.agentRef.info.licenseKey,applicationID:this.agentRef.info.applicationID}){const t=this.agentRef.info,i={};t.queueTime&&(i.qt=t.queueTime),t.applicationTime&&(i.ap=t.applicationTime),i.be=this.timeToFirstByte,i.fe=this.firstByteToWindowLoad,i.dc=this.firstByteToDomContent;const s={tt:t.ttGuid,us:t.user,ac:t.account,pr:t.product,af:A(this.agentIdentifier).join(","),...i,xx:t.extra,ua:t.userAttributes,at:t.atts};this.agentRef.runtime.session&&(s.fsh=Number(this.agentRef.runtime.session.isNew));let n;if(typeof e=="object"&&Object.keys(e).length>0&&(n=S({ja:e},this.obfuscator.obfuscateString.bind(this.obfuscator),"string")),h.performance){if(typeof PerformanceNavigationTiming<"u"){const a=h?.performance?.getEntriesByType("navigation")?.[0],v={timing:l(f,a,{}),navigation:T(a,{})};s.perf=g(v)}else if(typeof PerformanceTiming<"u"){const a={timing:l(f,h.performance.timing,{},!0),navigation:T(h.performance.navigation,{})};s.perf=g(a)}}s.fp=D.current.value,s.fcp=F.current.value;const m=this.agentRef.runtime.timeKeeper;m?.ready&&(s.timestamp=Math.floor(m.correctRelativeTimestamp(p()))),this.rumStartTime=p(),this.agentRef.runtime.harvester.triggerHarvestFor(this,{directSend:{targetApp:r,payload:{qs:s,body:n}},needResponse:!0,sendEmptyBody:!0})}postHarvestCleanup({status:e,responseText:r,xhr:t,targetApp:i}){const s=p();let n,m;try{({app:n,...m}=JSON.parse(r)),this.processEntities(n.agents,i)}catch(a){c(53,a)}if(y(i,this.agentRef)){if(e>=400||e===0){c(18,e),this.ee.abort();return}try{if(this.agentRef.runtime.timeKeeper.processRumRequest(t,this.rumStartTime,s,n.nrServerTime),!this.agentRef.runtime.timeKeeper.ready)throw new Error("TimeKeeper not ready")}catch(a){this.ee.abort(),c(17,a);return}Object.keys(this.agentRef.runtime.appMetadata).length||(this.agentRef.runtime.appMetadata=n),this.drain(),this.agentRef.runtime.harvester.startTimer(),B(m,this.agentRef)}}processEntities(e,r){!e||!r||e.forEach(t=>{const i=this.agentRef.runtime.entityManager,s=t.entityGuid;i.get(s)||(y(r,this.agentRef)&&i.setDefaultEntity({...r,entityGuid:s}),i.set(t.entityGuid,{...r,entityGuid:s}))})}}export{P as Aggregate};
//# sourceMappingURL=index-BuRaGUz4.js.map
