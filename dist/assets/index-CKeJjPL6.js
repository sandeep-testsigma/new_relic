import{i as W,H as ft,I as mt,J as Nt,d as u,K as tt,L as pt,A as et,D as vt,N as it,O as gt,h as Tt,a as rt,S as Et,w as It}from"./index-Bqulmxro.js";import{n as xt}from"./nav-timing-BJJZNqVX.js";import{c as V,A as bt}from"./aggregate-base-C5buiWcF.js";import{g as nt,b as p,n as b,a as at}from"./bel-serializer-cLbpUTfr.js";import{f as Lt,a as Ct}from"./first-paint-DDmO0Pf9.js";var Ft=128,Pt=0;function Z(g,r,t,h){Object.defineProperty(this,"interaction",{value:g,writable:!0}),this.parent=r,this.id=++Pt,this.type=t,this.children=[],this.end=null,this.jsEnd=this.start=h,this.jsTime=0,this.attrs={},this.cancelled=!1}var $=Z.prototype;$.child=function(r,t,h,s){var o=this.interaction;if(o.end||o.nodes>=Ft)return null;o.onNodeAdded(this);var l=new Z(o,this,r,t);return l.attrs.name=h,o.nodes++,s||o.remaining++,l};$.callback=function(r,t){var h=this;h.jsTime+=r,t>h.jsEnd&&(h.jsEnd=t,h.interaction.lastCb=t)};$.cancel=function(){this.cancelled=!0;var r=this.interaction;r.remaining--};$.finish=function(r){var t=this;if(t.end)return;t.end=r;let h=t.parent;for(;h?.cancelled;)h=h.parent;h&&h.children.push(t),t.parent=null;var s=this.interaction;s.remaining--,s.lastFinish=r,s.checkFinish()};var st=ft().o.ST,At=ft().o.CT,ot={};function J(g,r,t,h,s,o){this.agentRef=o,ot[o.agentIdentifier]=0,this.id=++ot[o.agentIdentifier],this.eventName=g,this.nodes=0,this.remaining=0,this.finishTimer=null,this.checkingFinish=!1,this.lastCb=this.lastFinish=r,this.handlers=[],this.onFinished=s,this.done=!1;var l=this.root=new Z(this,null,"interaction",r),T=l.attrs;T.trigger=g,T.initialPageURL=W,T.oldRoute=h,T.newURL=t,T.oldURL=g==="initialPageLoad"?document.referrer:t,T.custom={},T.store={}}var U=J.prototype;U.checkFinish=function(){var r=this;if(r.remaining>0){r._resetFinishCheck();return}r.checkingFinish||r.root.end===null&&(r._resetFinishCheck(),r.checkingFinish=!0,r.finishTimer=st(()=>{r.checkingFinish=!1,r.finishTimer=st(()=>{r.finishTimer=null,r.remaining<=0&&r.finish()},1)},0))};U.setNewURL=function(r){this.root.attrs.newURL=r};U.setNewRoute=function(r){this.root.attrs.newRoute=r};U.onNodeAdded=function(){this._resetFinishCheck()};U._resetFinishCheck=function(){this.finishTimer&&(At(this.finishTimer),this.finishTimer=null,this.checkingFinish=!1)};U.finish=function(){var r=this,t=r.root;if(t.end===null){var h=Math.max(r.lastCb,r.lastFinish),s=t.attrs,o=s.custom;this.onFinished&&this.onFinished(this),Object.entries(r.agentRef.info.jsAttributes||{}).forEach(([l,T])=>{l in o||(o[l]=T)}),t.end=h,r.agentRef.ee.emit("interaction",[this])}};class _t{constructor(r){this.obfuscator=r.runtime.obfuscator,this.info=r.info,this.firstTimestamp=void 0}serializeMultiple(r,t,h){var s=nt(this.obfuscator),o="bel.7";return r.forEach(l=>{o+=";"+this.serializeInteraction(l.root,t,h,l.routeChange,s,this.info)}),this.firstTimestamp=void 0,o}serializeSingle(r,t,h,s){var o=nt(this.obfuscator),l="bel.7;"+this.serializeInteraction(r,t,h,s,o,this.info);return this.firstTimestamp=void 0,l}serializeInteraction(r,t,h,s,o,l){t=t||0;var T=r.attrs.trigger==="initialPageLoad",G={interaction:1,ajax:2,customTracer:4},_=!0;const j=(c,x)=>{if(c.type==="customEnd")return x.push([3,p(c.end-this.firstTimestamp)]);var z=c.type,F=G[z],w=c.start,S=c.children.length,k=0,O=l.atts,M=T&&h.length&&F===1,C=[],f=c.attrs,D=f.metrics,d=f.params,R=l.queueTime,K=l.applicationTime;typeof this.firstTimestamp>"u"?(w+=t,this.firstTimestamp=w):w-=this.firstTimestamp;var P=[p(w),p(c.end-c.start),p(c.jsEnd-c.end),p(c.jsTime)];switch(F){case 1:P[2]=p(c.jsEnd-this.firstTimestamp),P.push(o(f.trigger),o(V(f.initialPageURL,_)),o(V(f.oldURL,_)),o(V(f.newURL,_)),o(f.customName),T?"":s?1:2,b(T&&R,p,!0)+b(T&&K,p,!0)+b(f.oldRoute,o,!0)+b(f.newRoute,o,!0)+o(f.id),o(c.id),b(f.firstPaint,p,!0)+b(f.firstContentfulPaint,p,!1));var e=at(f.custom,o);C=C.concat(e),k=e.length,O&&(S++,C.push("a,"+o(O)));break;case 2:if(P.push(o(d.method),p(d.status),o(d.host),o(d.pathname),p(D.txSize),p(D.rxSize),f.isFetch?1:f.isJSONP?2:"",o(c.id),b(c.dt&&c.dt.spanId,o,!0)+b(c.dt&&c.dt.traceId,o,!0)+b(c.dt&&c.dt.timestamp,p,!1)),Object.keys(d?.gql||{}).length){var i=at(d.gql,o);C=C.concat(i),k=i.length}break;case 4:var n=f.tracedTime;P.push(o(f.name),b(n,p,!0)+o(c.id));break}for(var a=0;a<c.children.length;a++)j(c.children[a],C);if(P.unshift(p(F),p(S+=k)),x.push(P),S&&x.push(C.join(";")),M){var N=",",E="b",y=0;Object.values(h.slice(1,21)||{}).forEach(X=>{X!==void 0?(E+=N+p(X-y),N=",",y=X):(E+=N+"!",N="")}),x.push(E)}else F===1&&x.push("");return x};return j(r,[]).join(";")}}const{FEATURE_NAME:ut,INTERACTION_EVENTS:ct,MAX_TIMER_BUDGET:B,FN_START:A,FN_END:ht,CB_START:H,INTERACTION_API:L,REMAINING:I,INTERACTION:v,SPA_NODE:m,JSONP_NODE:q,FETCH_START:Y,FETCH_DONE:dt,FETCH_BODY:lt,JSONP_END:Q,originalSetTimeout:jt}=mt;class Rt extends bt{static featureName=ut;constructor(r){super(r,ut);const t=this.state={initialPageURL:W,lastSeenUrl:W,lastSeenRouteName:null,timerMap:{},timerBudget:B,currentNode:null,prevNode:null,nodeOnLastHashUpdate:null,initialPageLoad:null,pageLoaded:!1,childTime:0,depth:0,disableSpaFix:(r.init.feature_flags||[]).indexOf("disable-spa-fix")>-1};this.spaSerializerClass=new _t(r);const h=this,s=Nt.get(r.agentIdentifier),o=s.get("mutation"),l=s.get("promise"),T=s.get("history"),G=s.get("events"),_=s.get("timer"),j=s.get("fetch"),c=s.get("jsonp"),x=s.get("xhr"),z=s.get("tracer");let F;if(this.waitForFlags(["spa"]).then(([e])=>{e?(F=r.runtime.harvester,this.drain()):(this.blocked=!0,this.deregisterDrain())}),r.init.spa.enabled!==!0)return;t.initialPageLoad=new J("initialPageLoad",0,t.lastSeenUrl,t.lastSeenRouteName,R,r),t.initialPageLoad.save=!0,r.runtime.session?.isNew&&(t.initialPageLoad.root.attrs.custom.isFirstOfSession=!0),t.prevInteraction=t.initialPageLoad,t.currentNode=t.initialPageLoad.root,t.initialPageLoad[I]++,u(A,S,this.featureName,s),u(H,S,this.featureName,l);var w={getCurrentNode:D,setCurrentNode:d};u("spa-register",function(e){typeof e=="function"&&e(w)},rt.spa,s);function S(){t.depth++,this.prevNode=t.currentNode,this.ct=t.childTime,t.childTime=0,t.timerBudget=B}u(ht,k,this.featureName,s),u("cb-end",k,this.featureName,l);function k(){t.depth--;var e=this.jsTime||0,i=e-t.childTime;t.childTime=this.ct+e,t.currentNode&&(t.currentNode.callback(i,this[ht]),this.isTraced&&(t.currentNode.attrs.tracedTime=i)),this.jsTime=t.currentNode?0:i,d(this.prevNode),this.prevNode=null,t.timerBudget=B}u(A,function(e,i){var n=e[0],a=n.type,N=n[`__nrNode:${tt}`];if(!t.pageLoaded&&(a==="load"&&i===window||pt)&&(t.pageLoaded=!0,this.prevNode=t.currentNode=null,t.initialPageLoad&&(N=t.initialPageLoad.root,t.initialPageLoad[I]=0,jt(function(){ct.push("popstate")}))),N)d(N);else if(a==="hashchange")d(t.nodeOnLastHashUpdate),t.nodeOnLastHashUpdate=null;else if(i instanceof XMLHttpRequest)d(s.context(i).spaNode);else if(!t.currentNode&&ct.indexOf(a)!==-1){var E=new J(a,this[A],t.lastSeenUrl,t.lastSeenRouteName,R,r);if(t.prevInteraction=E,d(E.root),a==="click"){var y=K(n.target);y&&(t.currentNode.attrs.custom.actionText=y)}}n[`__nrNode:${tt}`]=t.currentNode},this.featureName,G),u("setTimeout-end",function(i,n,a){!t.currentNode||t.timerBudget-this.timerDuration<0||i&&!(i[0]instanceof Function)||(t.currentNode[v][I]++,this.timerId=a,t.timerMap[a]=t.currentNode,this.timerBudget=t.timerBudget-50)},this.featureName,_),u("clearTimeout-start",function(i){var n=i[0],a=t.timerMap[n];if(a){var N=a[v];N[I]--,N.checkFinish(),delete t.timerMap[n]}},this.featureName,_),u(A,function(){t.timerBudget=this.timerBudget||B;var e=this.timerId,i=t.timerMap[e];d(i),delete t.timerMap[e],i&&i[v][I]--},this.featureName,_),u(A,function(){d(this[m])},this.featureName,x),u("new-xhr",function(){if(!t.disableSpaFix&&!t.currentNode&&t.prevInteraction&&!t.prevInteraction.ignored){const e=t.prevInteraction;t.currentNode=e.root,e.root.end=null}t.currentNode&&(this[m]=t.currentNode.child("ajax",null,null,!0))},this.featureName,x),u("send-xhr-start",function(){var e=this[m];e&&!this.sent&&(this.sent=!0,e.dt=this.dt,e.dt?.timestamp&&(e.dt.timestamp=r.runtime.timeKeeper.correctAbsoluteTimestamp(e.dt.timestamp)),e.jsEnd=e.start=this.startTime,e[v][I]++)},this.featureName,x),u("xhr-resolved",function(){var e=this[m];if(e){if(!et(this.params)){e.cancel();return}var i=e.attrs;i.params=this.params,i.metrics=this.metrics,e.finish(this.endTime),this.currentNode&&this.currentNode.interaction&&this.currentNode.interaction.checkFinish()}},this.featureName,s),u("new-jsonp",function(e){if(t.currentNode){var i=this[q]=t.currentNode.child("ajax",this[Y]);i.start=this["new-jsonp"],this.url=e,this.status=null}},this.featureName,c),u("cb-start",function(e){var i=this[q];i&&(d(i),this.status=200)},this.featureName,c),u("jsonp-error",function(){var e=this[q];e&&(d(e),this.status=0)},this.featureName,c),u(Q,function(){var e=this[q];if(e){if(this.status===null){e.cancel();return}var i=e.attrs,n=i.params={},a=vt(this.url);n.method="GET",n.pathname=a.pathname,n.host=a.hostname+":"+a.port,n.status=this.status,i.metrics={txSize:0,rxSize:0},i.isJSONP=!0,e.jsEnd=this[Q],e.jsTime=this[H]?this[Q]-this[H]:0,e.finish(e.jsEnd)}},this.featureName,c),u(Y,function(e,i){if(e){if(!t.disableSpaFix&&!t.currentNode&&t.prevInteraction&&!t.prevInteraction.ignored){const n=t.prevInteraction;t.currentNode=n.root,n.root.end=null}t.currentNode&&(this[m]=t.currentNode.child("ajax",this[Y]),i&&this[m]&&(this[m].dt=i,this[m].dt?.timestamp&&(this[m].dt.timestamp=r.runtime.timeKeeper.correctAbsoluteTimestamp(this[m].dt.timestamp))))}},this.featureName,j),u(lt+"start",function(e){t.currentNode&&(this[m]=t.currentNode,t.currentNode[v][I]++)},this.featureName,j),u(lt+"end",function(e,i,n){var a=this[m];a&&a[v][I]--},this.featureName,j),u(dt,function(e,i){var n=this[m];if(n){if(e||!et(this.params)){n.cancel();return}var a=n.attrs;a.params=this.params,a.metrics={txSize:this.txSize,rxSize:this.rxSize},a.isFetch=!0,n.finish(this[dt])}},this.featureName,j),u("newURL",function(e,i){if(t.currentNode)t.currentNode[v].setNewURL(e);else if(t.prevInteraction&&!t.prevInteraction.ignored){const n=t.prevInteraction;n.setNewURL(e),n.root.end=null,d(n.root)}t.currentNode&&(t.lastSeenUrl!==e&&(t.currentNode[v].routeChange=!0),i&&(t.nodeOnLastHashUpdate=t.currentNode)),t.lastSeenUrl=e},this.featureName,T),c.on("dom-start",function(e){if(!t.currentNode)return;var i=e[0],n=i&&i.nodeName==="SCRIPT"&&i.src!=="",a=t.currentNode.interaction;n&&(a[I]++,i.addEventListener("load",N,it(!1)),i.addEventListener("error",E,it(!1)));function N(){a[I]--,a.checkFinish()}function E(){a[I]--,a.checkFinish()}}),u(A,function(){d(t.prevNode)},this.featureName,o),u("resolve-start",f,this.featureName,l),u("executor-err",f,this.featureName,l),u("propagate",C,this.featureName,l),u(H,function(){var e=this.getCtx?this.getCtx():this;d(e[m])},this.featureName,l),u(L+"get",function(e){var i;t?.currentNode?.[v]?i=this.ixn=t.currentNode[v]:t?.prevNode?.end===null&&t?.prevNode?.[v]?.root?.[v]?.eventName!=="initialPageLoad"?i=this.ixn=t.prevNode[v]:i=this.ixn=new J("api",e,t.lastSeenUrl,t.lastSeenRouteName,R,r),t.currentNode||(i.checkFinish(),t.depth&&d(i.root))},this.featureName,s),u(L+"actionText",function(e,i){var n=this.ixn.root.attrs.custom;i&&(n.actionText=i)},this.featureName,s),u(L+"setName",function(e,i,n){var a=this.ixn.root.attrs;i&&(a.customName=i),n&&(a.trigger=n)},this.featureName,s),u(L+"setAttribute",function(e,i,n){this.ixn.root.attrs.custom[i]=n},this.featureName,s),u(L+"end",function(e){var i=this.ixn,n=M(i);d(null),n.child("customEnd",e)?.finish(e),i.finish()},this.featureName,s),u(L+"ignore",function(e){this.ixn.ignored=!0},this.featureName,s),u(L+"save",function(e){this.ixn.save=!0},this.featureName,s),u(L+"tracer",function(e,i,n){var a=this.ixn,N=M(a),E=s.context(n);if(!i)return E.inc=++a[I],E[m]=N;E[m]=N.child("customTracer",e,i)},this.featureName,s),u(A,O,this.featureName,z),u("no-"+A,O,this.featureName,z);function O(e,i,n){var a=this[m];if(a){var N=a[v],E=this.inc;this.isTraced=!0,E?N[I]--:a&&a.finish(e),n?d(a):N.checkFinish()}}u(L+"getContext",function(e,i){var n=this.ixn.root.attrs.store;setTimeout(function(){i(n)},0)},this.featureName,s),u(L+"onEnd",function(e,i){this.ixn.handlers.push(i)},this.featureName,s),u("api-routeName",function(e,i){t.lastSeenRouteName=i,t.currentNode&&t.currentNode[v].setNewRoute(i)},this.featureName,s);function M(e){return t.currentNode&&t.currentNode[v]===e?t.currentNode:e.root}function C(e,i){(i||!this[m])&&(this[m]=t.currentNode)}function f(){this.resolved||(this.resolved=!0,this[m]=t.currentNode)}function D(){return t.currentNode}function d(e){!t.pageLoaded&&!e&&t.initialPageLoad&&(e=t.initialPageLoad.root),t.currentNode&&t.currentNode[v].checkFinish(),t.prevNode=t.currentNode,t.currentNode=e&&!e[v].root.end?e:null}function R(e){e===t.initialPageLoad&&(t.initialPageLoad=null);var i=e.root,n=i.attrs;t.currentNode=i,Object.values(e.handlers||{}).forEach(function(a){a(n.store)}),d(null)}s.on("spa-jserror",function(e,i,n,a){t.currentNode&&(n._interactionId=t.currentNode.interaction.id,t.currentNode.type&&t.currentNode.type!=="interaction"&&(n._interactionNodeId=t.currentNode.id))}),u("function-err",function(e,i,n){t.currentNode&&(n.__newrelic??={},n.__newrelic[r.agentIdentifier]={interactionId:t.currentNode.interaction.id},t.currentNode.type&&t.currentNode.type!=="interaction"&&(n.__newrelic[r.agentIdentifier].interactionNodeId=t.currentNode.id))},this.featureName,s),s.on("interaction",P);function K(e){var i=e.tagName.toLowerCase(),n=["a","button","input"],a=n.indexOf(i)!==-1;if(a)return e.title||e.value||e.innerText}function P(e){if(e.ignored||!e.save&&!e.routeChange){s.emit("interactionDone",[e,!1]);return}t.prevInteraction===e&&(t.prevInteraction=null),e.root.attrs.id=gt(),e.root.attrs.trigger==="initialPageLoad"&&(e.root.attrs.firstPaint=Lt.current.value,e.root.attrs.firstContentfulPaint=Ct.current.value),s.emit("interactionDone",[e,!0]),h.events.add(e);let i;if(e.root?.attrs?.trigger==="initialPageLoad"?i="InitialPageLoad":e.routeChange?i="RouteChange":i="Custom",Tt(Et,[`Spa/Interaction/${i}/Duration/Ms`,Math.max((e.root?.end||0)-(e.root?.start||0),0)],void 0,rt.metrics,s),!F){It(19);return}F.triggerHarvestFor(h)}}serializer(r){return this.spaSerializerClass.serializeMultiple(r,0,xt)}}export{Rt as Aggregate};
//# sourceMappingURL=index-CKeJjPL6.js.map
