import{F as y,s as S,d as m,a as c,b as N,c as p,h as A}from"./index-tgZbi5_K.js";import{A as v}from"./aggregate-base-3_tx4224.js";import{i as x}from"./type-check-BVQCr-HH.js";import{g as T,n as h,a as l,b as R}from"./bel-serializer-LG_jYN14.js";function L({body:r,query:e}={}){if(!(!r&&!e))try{const t=I(E(r));if(t)return t;const s=j(M(e));if(s)return s}catch{}}function j(r){if(typeof r!="object"||!r.query||typeof r.query!="string")return;const e=r.query.trim().match(/^(query|mutation|subscription)\s?(\w*)/),t=e?.[1];return t?{operationName:r.operationName||e?.[2]||"Anonymous",operationType:t,operationFramework:"GraphQL"}:void 0}function I(r){if(!r)return;Array.isArray(r)||(r=[r]);const e=[],t=[];for(let s of r){const n=j(s);n&&(e.push(n.operationName),t.push(n.operationType))}if(t.length)return{operationName:e.join(","),operationType:t.join(","),operationFramework:"GraphQL"}}function E(r){let e;if(!r||typeof r!="string"&&typeof r!="object"||(typeof r=="string"?e=JSON.parse(r):e=r,!x(e)&&!Array.isArray(e)))return;let t=!1;if(Array.isArray(e)?t=e.some(s=>b(s)):t=b(e),!!t)return e}function M(r){if(!r||typeof r!="string")return;const e=new URLSearchParams(r);return E(Object.fromEntries(e))}function b(r){return!(typeof r!="object"||!r.query||typeof r.query!="string")}class O extends v{static featureName=y;constructor(e){super(e,y),S(e.runtime.denyList),this.underSpaEvents={};const t=this;this.ee.on("interactionDone",(s,n)=>{this.underSpaEvents[s.id]&&(n||this.underSpaEvents[s.id].forEach(i=>this.events.add(i)),delete this.underSpaEvents[s.id])}),m("returnAjax",s=>this.events.add(s),this.featureName,this.ee),m("xhr",function(){t.storeXhr(...arguments,this)},this.featureName,this.ee),this.waitForFlags([]).then(()=>this.drain())}storeXhr(e,t,s,n,i,a){t.time=s;let o;e.cat?o=c([e.status,e.cat]):o=c([e.status,e.host,e.pathname]);const d=N(e),f=this.agentRef.init.feature_flags?.includes("ajax_metrics_deny_list");if(!!this.agentRef.features?.[p.jserrors]&&(d||!f)&&this.agentRef.sharedAggregator?.add(["xhr",o,e,t]),!d){e.hostname===this.agentRef.info.errorBeacon||this.agentRef.init.proxy?.beacon&&e.hostname===this.agentRef.init.proxy.beacon?(this.reportSupportabilityMetric("Ajax/Events/Excluded/Agent"),f&&this.reportSupportabilityMetric("Ajax/Metrics/Excluded/Agent")):(this.reportSupportabilityMetric("Ajax/Events/Excluded/App"),f&&this.reportSupportabilityMetric("Ajax/Metrics/Excluded/App"));return}A("bstXhrAgg",["xhr",o,e,t],void 0,p.sessionTrace,this.ee);const u={method:e.method,status:e.status,domain:e.host,path:e.pathname,requestSize:t.txSize,responseSize:t.rxSize,type:i,startTime:s,endTime:n,callbackDuration:t.cbTime};if(a.dt&&(u.spanId=a.dt.spanId,u.traceId=a.dt.traceId,u.spanTimestamp=Math.floor(this.agentRef.runtime.timeKeeper.correctAbsoluteTimestamp(a.dt.timestamp))),u.gql=e.gql=L({body:a.body,query:a.parsedOrigin?.search}),u.gql&&this.reportSupportabilityMetric("Ajax/Events/GraphQL/Bytes-Added",c(u.gql).length),!!this.agentRef.features?.[p.softNav])A("ajax",[u],void 0,p.softNav,this.ee);else if(a.spaNode){const g=a.spaNode.interaction.id;this.underSpaEvents[g]??=[],this.underSpaEvents[g].push(u)}else this.events.add(u)}serializer(e){if(!e.length)return;const t=T(this.agentRef.runtime.obfuscator);let s="bel.7;";for(let n=0;n<e.length;n++){const i=e[n],a=[h(i.startTime),h(i.endTime-i.startTime),h(0),h(0),t(i.method),h(i.status),t(i.domain),t(i.path),h(i.requestSize),h(i.responseSize),i.type==="fetch"?1:"",t(0),l(i.spanId,t,!0)+l(i.traceId,t,!0)+l(i.spanTimestamp,h,!1)];let o="2,";const d=this.agentRef.info.jsAttributes,f=R({...d||{},...i.gql||{}},t);a.unshift(h(f.length)),o+=a.join(","),f&&f.length>0&&(o+=";"+f.join(";")),n+1<e.length&&(o+=";"),s+=o}return s}}export{O as Aggregate};
//# sourceMappingURL=index-D2tBZbTu.js.map
