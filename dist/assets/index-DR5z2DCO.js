import{ai as d,i as m,aj as p,a5 as M,B as c,a6 as u,D as E,L as r,d as b,ak as y,w as a,al as R,a as f,f as L}from"./index-DDRSPtx0.js";import{c as T,A as v,M as F}from"./aggregate-base-Cx63VZnL.js";import{a as O}from"./traverse-eGeoT8Mx.js";class A{timestamp;message;attributes;level;constructor(i,t,e={},s=d.INFO){this.timestamp=i,this.message=t,this.attributes={...e,pageUrl:T(""+m)},this.level=s.toUpperCase()}}class w extends v{static featureName=p;constructor(i){super(i,p),this.isSessionTrackingEnabled=M(i.init)&&i.runtime.session,this.ee.on(c.RESET,()=>{this.abort(u.RESET)}),this.ee.on(c.UPDATE,(t,e)=>{this.blocked||t!==E.CROSS_TAB||(this.loggingMode!==r.OFF&&e.loggingMode===r.OFF?this.abort(u.CROSS_TAB):this.loggingMode=e.loggingMode)}),this.harvestOpts.raw=!0,this.waitForFlags(["log"]).then(([t])=>{const e=this.agentRef.runtime.session??{};if(this.loggingMode===r.OFF||e.isNew&&t===r.OFF){this.blocked=!0,this.deregisterDrain();return}e.isNew||!this.isSessionTrackingEnabled?this.updateLoggingMode(t):this.loggingMode=e.state.loggingMode,b(y,this.handleLog.bind(this),this.featureName,this.ee),this.drain(),i.runtime.harvester.triggerHarvestFor(this)})}updateLoggingMode(i){this.loggingMode=i,this.syncWithSessionManager({loggingMode:this.loggingMode})}handleLog(i,t,e={},s=d.INFO,g){if(!this.agentRef.runtime.entityManager.get(g))return a(56,this.featureName);if(this.blocked||!this.loggingMode)return;if((!e||typeof e!="object")&&(e={}),typeof s=="string"&&(s=s.toUpperCase()),!R(s))return a(30,s);if(this.loggingMode<(r[s]||1/0)){this.reportSupportabilityMetric("Logging/Event/Dropped/Sampling");return}try{if(typeof t!="string"){const h=f(t);h&&h!=="{}"?t=h:t=String(t)}}catch{a(16,t),this.reportSupportabilityMetric("Logging/Event/Dropped/Casting");return}if(typeof t!="string"||!t)return a(32);const n=new A(Math.floor(this.agentRef.runtime.timeKeeper.correctRelativeTimestamp(i)),t,e,s),o=n.message.length+f(n.attributes).length+n.level.length+10,l="Logging/Harvest/Failed/Seen";if(o>F){this.reportSupportabilityMetric(l,o),a(31,n.message.slice(0,25)+"...");return}this.events.wouldExceedMaxSize(o,g)&&(this.reportSupportabilityMetric("Logging/Harvest/Early/Seen",this.events.byteSize()+o),this.agentRef.runtime.harvester.triggerHarvestFor(this,{targetEntityGuid:g})),this.events.add(n,g)?this.reportSupportabilityMetric("Logging/Event/Added/Seen"):(this.reportSupportabilityMetric(l,o),a(31,n.message.slice(0,25)+"..."))}serializer(i,t){const e=this.agentRef.runtime.entityManager.get(t),s=this.agentRef.runtime.session;return[{common:{attributes:{"entity.guid":e.entityGuid,...s&&{session:s.state.value||"0",hasReplay:s.state.sessionReplayMode===1&&L(e,this.agentRef),hasTrace:s.state.sessionTraceMode===1},ptid:this.agentRef.runtime.ptid,appId:e.applicationID||this.agentRef.info.applicationID,standalone:!!this.agentRef.info.sa,agentVersion:this.agentRef.runtime.version,"instrumentation.provider":"browser","instrumentation.version":this.agentRef.runtime.version,"instrumentation.name":this.agentRef.runtime.loaderType,...this.agentRef.info.jsAttributes}},logs:O(i,this.obfuscator.obfuscateString.bind(this.obfuscator),"string")}]}queryStringsBuilder(i,t){return{browser_monitoring_key:this.agentRef.runtime.entityManager.get(t).licenseKey}}abort(i={}){this.reportSupportabilityMetric("Logging/Abort/".concat(i.sm)),this.blocked=!0,this.events&&(this.events.clear(),this.events.clearSave()),this.updateLoggingMode(r.OFF),this.deregisterDrain()}syncWithSessionManager(i={}){this.isSessionTrackingEnabled&&this.agentRef.runtime.session.write(i)}}export{w as Aggregate};
//# sourceMappingURL=index-DR5z2DCO.js.map
